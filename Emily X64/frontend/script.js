const DEFAULT_CONFIG={app_name:"Emily AI",max_message_length:500,allowed_extensions:{document:[".pdf",".js",".py",".txt",".html",".css",".md",".csv",".xml",".rtf"],image:[".jpg",".jpeg",".png",".gif"]},suggestions:["Tell me about yourself","How can you help me?","What are your capabilities?","Show me some examples"],user:{name:"User",avatar:""}},APP_CONFIG=window.APP_CONFIG||DEFAULT_CONFIG,USER_INFO=window.USER_INFO||APP_CONFIG.user||{name:"User",avatar:""},sidebar=document.getElementById("sidebar"),mainContent=document.getElementById("main-content"),sidebarToggle=document.getElementById("sidebar-toggle"),chatArea=document.getElementById("chat-area"),messageInput=document.getElementById("message-input"),sendButton=document.getElementById("send-button"),attachmentButton=document.getElementById("attachment-button"),attachmentDropdown=document.getElementById("attachment-dropdown"),emptyChatPlaceholder=document.getElementById("empty-chat-placeholder"),suggestionGrid=document.querySelector(".suggestion-grid"),settingsButton=document.getElementById("settings-button"),appNameElement=document.getElementById("app-name"),profileNameElement=document.getElementById("profile-name"),profileAvatarElement=document.getElementById("profile-avatar"),emptyChatTitle=document.getElementById("empty-chat-title"),systemInfoButton=document.getElementById("system-info-button"),accountButton=document.getElementById("account-button"),logoutButton=document.getElementById("logout-button"),historyButton=document.getElementById("history-button"),memoryButton=document.getElementById("memory-button");let selectedFiles=[],selectedNativePath=null,isAttachmentDropdownOpen=!1,isProcessing=!1,uploadConfig={document:{maxFiles:3,currentCount:0},image:{maxFiles:5,currentCount:0}},fileUploadStatusElements={};const errorTypes={CRITICAL:{title:"Critical Error",destroy:!0},WARNING:{title:"Warning",destroy:!1},INFO:{title:"Information",destroy:!1},AUTHENTICATION:{title:"Authentication Error",destroy:!1},API_ERROR:{title:"API Error",destroy:!1},NETWORK:{title:"Network Error",destroy:!1},SYSTEM:{title:"System Error",destroy:!0}};function destroyAppWindow(){return new Promise((e=>{if(window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.close_window)try{return e(window.pywebview.api.close_window()||{success:!0,message:"Window close initiated"})}catch(e){}if("function"==typeof window.destroyWindow)try{return e(window.destroyWindow()||{success:!0,message:"Window destroy initiated via window.destroyWindow"})}catch(e){}try{return window.close(),e({success:!0,message:"Used window.close fallback, result unknown"})}catch(e){}return e({success:!1,message:"No method available to destroy window"})}))}function testDestroyWindow(){addMessageToChat({sender:"System",text:"Testing window destroy function. The window will be destroyed in 3 seconds...\n\nUsing method: "+(window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.close_window?"close_window API":"window.destroyWindow"),isUser:!1}),setTimeout((()=>{destroyAppWindow().then((e=>{setTimeout((()=>{addMessageToChat({sender:"System",text:`Failed to destroy window. Result: ${JSON.stringify(e)}`,isUser:!1})}),1e3)})).catch((e=>{addMessageToChat({sender:"System",text:`Error destroying window: ${e}`,isUser:!1})}))}),3e3)}function showErrorMessage(e,t=!1,n="Error"){let o="",i=t,a=n;if("object"==typeof e){if(e.type&&errorTypes[e.type]){const t=errorTypes[e.type];a=e.title||t.title,i=void 0!==e.destroy?e.destroy:t.destroy}else a=e.title||n,i=void 0!==e.destroy?e.destroy:t;o=e.message||e.description||(e.toString?e.toString():"Unknown error")}else o=e?e.toString():"Unknown error";if("function"==typeof window.showError)return window.showError(i,o,a);if(window.pywebview&&window.pywebview.api){const e=findApiFunction("showError");if(e)return e(i,o,a)}return alert(`${a}: ${o}`),i&&setTimeout((()=>destroyAppWindow()),1e3),Promise.resolve({success:!1,message:"Used alert fallback for error",details:{title:a,description:o,destroyed:i}})}function initializeApp(e){if(e){if((!e.newuser||"false"===String(e.newuser).toLowerCase())&&"function"==typeof startFirstSetup)return void startFirstSetup()}const t=e||APP_CONFIG||DEFAULT_CONFIG,n=window.USER_INFO||t.user||USER_INFO;document.title=t.app_name||"Emily AI",appNameElement&&(appNameElement.textContent=t.app_name||"Emily AI"),emptyChatTitle&&(emptyChatTitle.textContent=`Welcome to ${t.app_name||"Emily AI"}`),updateUserProfile(n),messageInput&&(messageInput.maxLength=t.max_message_length||500),ensureInputWrapperStructure(),createSuggestions(t.suggestions||[]),updateUserTypeBox(),updateSubscriptionButton(),window.APP_CONFIG?.userLang&&updateVoiceLanguage(window.APP_CONFIG.userLang),void 0!==window.APP_CONFIG?.isvoiseactive&&(isvoiseactive="true"===String(window.APP_CONFIG.isvoiseactive).toLowerCase())}function updateUserProfile(e){const t=e||USER_INFO;if(profileNameElement&&(profileNameElement.textContent=t.name||"User"),profileAvatarElement){let e=t.avatar;e&&"null"!==e&&null!==e&&isValidHttpUrl(e)||(e="./assets/avatar_defolt.gif"),profileAvatarElement.src=e}}function createSuggestions(e){if(!suggestionGrid)return;const t=e||APP_CONFIG.suggestions||[];suggestionGrid.innerHTML="",t.forEach((e=>{const t=document.createElement("div");t.className="suggestion-card",t.textContent=e,t.addEventListener("click",(()=>{messageInput.value=e,sendMessage()})),suggestionGrid.appendChild(t)}))}function ensureInputWrapperStructure(){const e=document.querySelector(".input-wrapper");if(e&&!e.querySelector(".input-row")){const t=document.createElement("div");for(t.className="input-row";e.firstChild;)t.appendChild(e.firstChild);e.appendChild(t)}}function getAcceptForType(e){return(APP_CONFIG.allowed_extensions[e]||[]).join(",")}function addFilePreview(e,t){const n=document.createElement("div");n.className="file-preview",n.innerHTML=`\n        <i class="fas fa-${"document"===t?"file":t}"></i>\n        <span>${e}</span>\n        <button>Ã—</button>\n    `,n.querySelector("button").addEventListener("click",(()=>{n.remove(),uploadConfig[t].currentCount--,selectedFiles=selectedFiles.filter((t=>t.name!==e))}));let o=document.querySelector(".file-preview-container");if(!o){o=document.createElement("div"),o.className="file-preview-container";document.querySelector(".input-wrapper").appendChild(o)}o.appendChild(n)}function addThinkingAnimation(){const e=document.createElement("div");return e.className="thinking-animation",e.innerHTML='\n        <div class="thinking-dot"></div>\n        <div class="thinking-dot"></div>\n        <div class="thinking-dot"></div>\n    ',chatArea.appendChild(e),chatArea.scrollTo({top:chatArea.scrollHeight,behavior:"smooth"}),e}function removeThinkingAnimation(e){e&&e.parentNode&&e.parentNode.removeChild(e)}function showFileUploadStatus(e,t,n=null){let o=fileUploadStatusElements[e];return o||(o=document.createElement("div"),o.className="file-upload-status",chatArea.appendChild(o),fileUploadStatusElements[e]=o),o.innerHTML=`\n        <div class="file-upload-info">\n            <i class="fas fa-${"uploading"===t?"spinner fa-spin":"success"===t?"check-circle":"error"===t?"exclamation-circle":"file"}"></i>\n            <span class="file-name">${e}</span>\n            <span class="status-text">${t.toUpperCase()}</span>\n        </div>\n        ${n?`<div class="error-message">${n}</div>`:""}\n    `,"success"!==t&&"error"!==t||setTimeout((()=>{o&&o.parentNode&&(o.parentNode.removeChild(o),delete fileUploadStatusElements[e])}),2e3),chatArea.scrollTo({top:chatArea.scrollHeight,behavior:"smooth"}),o}function sendMessage(){const e=messageInput.value.trim();if(!e&&0===selectedFiles.length)return;if(isProcessing)return;isProcessing=!0,sendButton.disabled=!0,messageInput.disabled=!0,emptyChatPlaceholder&&"none"!==emptyChatPlaceholder.style.display&&(emptyChatPlaceholder.style.display="none"),addMessageToChat({sender:USER_INFO.name||"You",text:e,isUser:!0,files:selectedFiles.map((e=>({name:e.name,type:e.type,data:e.data})))});const t=addThinkingAnimation(),n={};selectedFiles.forEach((e=>{n[e.name]=showFileUploadStatus(e.name,"uploading")}));const o={text:e,files:selectedFiles.map((e=>({name:e.name,type:e.type,data:e.data,size:e.size,mimeType:e.mimeType})))};if(window.pywebview&&window.pywebview.api){const e=findApiFunction("sendMessageToBackend");e?e(JSON.stringify(o),isvoiseactive).then((()=>{selectedFiles.forEach((e=>{n[e.name]&&(n[e.name].remove(),showFileUploadStatus(e.name,"success"))})),removeThinkingAnimation(t),isProcessing=!1,sendButton.disabled=!1,messageInput.disabled=!1,messageInput.focus()})).catch((e=>{selectedFiles.forEach((t=>{n[t.name]&&(n[t.name].remove(),showFileUploadStatus(t.name,"error",e.message||"Upload failed"))})),removeThinkingAnimation(t),addMessageToChat({sender:"System",text:"Error sending message. Please try again.",isUser:!1}),isProcessing=!1,sendButton.disabled=!1,messageInput.disabled=!1,messageInput.focus()})):(removeThinkingAnimation(t),isProcessing=!1,sendButton.disabled=!1,messageInput.disabled=!1,messageInput.focus())}messageInput.value="",selectedFiles=[],document.querySelectorAll(".file-preview").forEach((e=>e.remove()));const i=document.querySelector(".file-preview-container");i&&(i.innerHTML=""),Object.keys(uploadConfig).forEach((e=>{uploadConfig[e].currentCount=0})),autoResizeTextarea()}function getFileType(e){const t=e.split(".").pop().toLowerCase();for(const[e,n]of Object.entries(APP_CONFIG.allowed_extensions))if(n.includes("."+t))return e;return"document"}function addCopyButtonToCodeBlock(e){if(e.parentElement.classList.contains("code-block-wrapper")||e.closest(".message-bubble"))return;const t=e.querySelector("code");if(t){const n=document.createElement("button");n.className="icon-btn code-copy-btn",n.title="Copy code",n.innerHTML='<i class="fad fa-copy"></i>',n.addEventListener("click",(()=>{navigator.clipboard.writeText(t.textContent).then((()=>{showToast({message:"Code copied to clipboard!",type:"success",duration:2e3})})).catch((e=>{showToast({message:"Failed to copy code.",type:"error",duration:2e3})}))}));const o=document.createElement("div");o.className="code-block-wrapper",e.parentNode.insertBefore(o,e),o.appendChild(e),o.appendChild(n)}}function wrapCodeBlockInMessage(e){if(e.closest(".message-bubble"))return;const t=document.createElement("div");t.className="message-bubble ai-message";const n=document.createElement("div");n.className="message-text",e.parentNode.insertBefore(t,e),n.appendChild(e),t.appendChild(n),addCopyButtonToCodeBlock(e)}function showImagePopup(e,t){const n=document.createElement("div");n.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0,0,0,0.85);\n        backdrop-filter: blur(8px);\n        z-index: 4000;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        padding: 20px;\n    ";const o=document.createElement("div");o.style.cssText="\n        background: rgba(20, 16, 40, 0.98);\n        border-radius: 18px;\n        padding: 1.5rem;\n        max-width: 90vw;\n        max-height: 90vh;\n        color: #fff;\n        box-shadow: 0 8px 32px rgba(0,0,0,0.4);\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        position: relative;\n        overflow: hidden;\n    ",o.innerHTML=`\n        <div style="font-size:1.2rem;font-weight:600;margin-bottom:1rem;text-align:center;max-width:90%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${t}</div>\n        <img src="${e}" alt="${t}" style="max-width:100%; max-height:calc(90vh - 120px); object-fit:contain; border-radius:12px; margin-bottom:1.5rem;">\n        <div style="display:flex;gap:1rem;justify-content:flex-end;width:100%;">\n            <button class="icon-btn copy-image-btn" title="Copy Image URL"><i class="fad fa-link"></i></button>\n            <button class="icon-btn close-image-popup-btn" title="Close"><i class="fad fa-times"></i></button>\n        </div>\n    `,n.appendChild(o),document.body.appendChild(n),o.querySelector(".copy-image-btn").onclick=function(){navigator.clipboard.writeText(e).then((()=>{showToast({message:"Image URL copied!",type:"success",duration:2e3})})).catch((e=>{showToast({message:"Failed to copy image URL.",type:"error",duration:2e3})}))},o.querySelector(".close-image-popup-btn").onclick=function(){n.remove()},n.onclick=function(e){e.target===n&&n.remove()}}function addMessageToChat(e){try{const t=document.createElement("div");t.className="message-bubble "+(e.isUser?"user-message":"ai-message"),t.dataset.markdown=e.text||"",!e.isUser&&isVoiceMode&&(safelyStopListening(),e.voise_uri&&"none"!==e.voise_uri&&isvoiseactive?(audioPlaybackInProgress=!0,setTimeout((()=>{playAudio(e.voise_uri,(()=>{isVoiceMode&&safelyStartListening()}))}),100)):setTimeout((()=>{isVoiceMode&&safelyStartListening()}),800));const n=document.createElement("div");n.className="message-sender",n.textContent=e.sender;const o=document.createElement("div");if(o.className="message-text",o.innerHTML=marked.parse(e.text),o.querySelectorAll("pre").forEach(addCopyButtonToCodeBlock),o.querySelectorAll("a").forEach((e=>{e.addEventListener("click",(t=>{t.preventDefault();const n=e.getAttribute("href");n&&openExternalLink(n)}))})),t.appendChild(n),t.appendChild(o),e.files&&e.files.length>0){const n=document.createElement("div");n.className="message-files-container",e.files.forEach((e=>{const t=document.createElement("div");t.className=`message-file-item ${e.type}-item`,"image"===e.type&&e.data?(t.innerHTML=`\n                        <img src="${e.data}" alt="${e.name}" class="message-image-thumbnail">\n                        <div class="file-name">${e.name}</div>\n                    `,t.addEventListener("click",(()=>showImagePopup(e.data,e.name)))):t.innerHTML=`\n                <div class="file-icon">\n                            <i class="fas fa-${"document"===e.type?"file-alt":e.type}"></i>\n                </div>\n                <div class="file-name">${e.name}</div>\n            `,n.appendChild(t)})),t.appendChild(n)}const i=document.createElement("div");i.className="message-bubble-actions";const a=document.createElement("button");a.className="icon-btn copy-btn",a.title="Copy markdown",a.innerHTML='<i class="fad fa-copy"></i>',a.onclick=()=>{navigator.clipboard.writeText(t.dataset.markdown).then((()=>{showToast({message:"Copied to clipboard!",type:"success",duration:2e3})}))};const r=document.createElement("button");r.className="icon-btn maximize-btn",r.title="Maximize",r.innerHTML='<i class="fad fa-expand-arrows"></i>',r.onclick=()=>showMaximizePopup(t.dataset.markdown),i.appendChild(a),i.appendChild(r),t.appendChild(i);const s=document.getElementById("chat-area");s.appendChild(t),s.scrollTop=s.scrollHeight}catch(e){showToast({message:"Error displaying message.",type:"error",duration:4e3})}!e.isUser&&!isVoiceMode&&e.voise_uri&&"none"!==e.voise_uri&&isvoiseactive&&playAudio(e.voise_uri)}function showMaximizePopup(e){const t=document.createElement("div");t.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0,0,0,0.55);\n        backdrop-filter: blur(6px);\n        z-index: 3000;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n    ";const n=document.createElement("div");n.style.cssText="\n        background: rgba(20, 16, 40, 0.98);\n        border-radius: 18px;\n        padding: 2rem 2.5rem;\n        min-width: 90%;\n        max-width: 90vw;\n        max-height: 100vh;\n        color: #fff;\n        box-shadow: 0 8px 32px rgba(0,0,0,0.25);\n        display: flex;\n        flex-direction: column;\n        align-items: stretch;\n        position: relative;\n        overflow-y: auto;\n    ",n.innerHTML=`\n        <div style="font-size:1.2rem;font-weight:600;margin-bottom:1.2rem;text-align:center;">Full Message</div>\n        <textarea readonly style="width:100%;height:60vh;resize:vertical;border-radius:8px;padding:1rem;font-size:1rem;background:rgba(255,255,255,0.07);color:#fff;outline:none;border:none;">${e}</textarea>\n        <div style="display:flex;gap:1rem;justify-content:flex-end;margin-top:1.5rem;">\n            <button class="icon-btn copy-btn" title="Copy"><i class="fad fa-copy"></i></button>\n            <button class="icon-btn close-btn" title="Close"><i class="fad fa-times"></i></button>\n                </div>\n    `,t.appendChild(n),document.body.appendChild(t),n.querySelector(".copy-btn").onclick=function(){navigator.clipboard.writeText(e).then((()=>{showToast({message:"Copied to clipboard!",type:"success",duration:2e3})}))},n.querySelector(".close-btn").onclick=function(){t.remove()}}function autoResizeTextarea(){messageInput.style.height="auto";const e=Math.min(messageInput.scrollHeight,120);messageInput.style.height=`${e}px`;const t=document.querySelector(".file-preview-container");t&&(t.children.length>0?t.style.minHeight="40px":t.style.minHeight="0")}function isPywebviewReady(){return void 0!==window.pywebview&&null!==window.pywebview&&void 0!==window.pywebview.api&&null!==window.pywebview.api}function waitForPywebview(e,t=10,n=500){let o=0;const i=()=>{o++,isPywebviewReady()?e():o>=t||setTimeout(i,n)};i()}function loadUserInfo(){if(window.USER_INFO)updateUserProfile(window.USER_INFO);else{if("function"==typeof window.getUserInfo)try{return void window.getUserInfo().then((e=>{e&&(window.USER_INFO=e,updateUserProfile(e))})).catch((e=>{fallbackToDefaultUserInfo()}))}catch(e){}if(isPywebviewReady()){const e=findApiFunction("getUserInfo");if(e)try{return void e().then((e=>{e&&(window.USER_INFO=e,updateUserProfile(e))})).catch((e=>{fallbackToDefaultUserInfo()}))}catch(e){}}fallbackToDefaultUserInfo()}}function fallbackToDefaultUserInfo(){updateUserProfile(USER_INFO)}function initializeWithBackend(){if(window.APP_CONFIG)initializeApp(window.APP_CONFIG);else{if("function"==typeof window.getConfig)try{return void window.getConfig().then((e=>{e&&(window.APP_CONFIG=e,initializeApp(e))})).catch((e=>{initializeApp(DEFAULT_CONFIG)}))}catch(e){}if(isPywebviewReady()){const e=findApiFunction("getConfig");if(e)try{return void e().then((e=>{e&&(window.APP_CONFIG=e,initializeApp(e))})).catch((e=>{initializeApp(DEFAULT_CONFIG)}))}catch(e){initializeApp(DEFAULT_CONFIG)}}initializeApp(DEFAULT_CONFIG)}}function findApiFunction(e){if(!window.pywebview||!window.pywebview.api)return null;if("function"==typeof window.pywebview.api[e])return window.pywebview.api[e];const t=Object.keys(window.pywebview.api).find((t=>t.toLowerCase()===e.toLowerCase()));if(t&&"function"==typeof window.pywebview.api[t])return window.pywebview.api[t];const n=[e,e.toLowerCase(),toSnakeCase(e),toCamelCase(toSnakeCase(e))];for(const t of n)if(t!==e&&"function"==typeof window.pywebview.api[t])return window.pywebview.api[t];return null}function toSnakeCase(e){return e.replace(/([A-Z])/g,"_$1").toLowerCase()}function toCamelCase(e){return e.replace(/_([a-z])/g,((e,t)=>t.toUpperCase()))}function cleanupPendingAttachments(){selectedFiles=[],document.querySelectorAll(".file-preview").forEach((e=>e.remove()));const e=document.querySelector(".file-preview-container");e&&(e.innerHTML=""),Object.keys(uploadConfig).forEach((e=>{uploadConfig[e].currentCount=0}))}function handleSystemInfoClick(){const e=window.APP_CONFIG||APP_CONFIG;if(!e)return void showToast({message:"System information not available",type:"error",duration:3e3});const t=e.latest_version_info?.leatest_version||"N/A",n=e.latest_version_info?.relese_type||"N/A",o=e.current_version||"N/A",i=e.current_version_code||"N/A",a=e.gemini?.model||"N/A",r=(s=e.devise_id||"")&&"string"==typeof s?s.length<=8?s:s.slice(0,4)+"*".repeat(s.length-8)+s.slice(-4):"";var s;const d=e.windows_info||"N/A",l=e.dev_info||"",c="dev-info-iframe",p=l?`\n        <div style="margin-top:2.5rem;width:100%;">\n            <h3 style="font-size:1.1rem;font-weight:600;margin-bottom:0.7rem;color:var(--primary-color);letter-spacing:0.02em;">Developer Info</h3>\n            <iframe id="dev-info-iframe" \n                srcdoc="<style>body{margin:0;padding:1rem;} ::-webkit-scrollbar{display:none;} html,body{scrollbar-width:none;-ms-overflow-style:none;}</style>${l.replace(/"/g,"&quot;").replace(/'/g,"&#39;")}" \n                style="width:100%;border-radius:12px;border:1px solid var(--border-light);background:rgba(0,0,0,0.08);margin-bottom:0.5rem;overflow:auto;" \n                scrolling="auto" \n                frameborder="0"\n                onload="resizeIframe(this)">\n            </iframe>\n        </div>\n    `:"";window.resizeIframe=function(e){try{const t=e.contentDocument||e.contentWindow.document;t&&(e.style.height=t.body.scrollHeight+"px")}catch(e){}};showPopupBelowHeader({title:"System & App Information",contentHtml:`\n        <div class = "system-info-container" style="display:flex;flex-direction:column;gap:1rem;min-width:70%;padding:0.5rem;max-height:80vh;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--primary-color) rgba(255,255,255,0.1);">\n            <style>\n                .system-info-container::-webkit-scrollbar {\n                    width: 8px;\n                }\n                .system-info-container::-webkit-scrollbar-track {\n                    background: rgba(255,255,255,0.1);\n                    border-radius: 4px;\n                }\n                .system-info-container::-webkit-scrollbar-thumb {\n                    background: var(--primary-color);\n                    border-radius: 4px;\n                }\n                .system-info-container::-webkit-scrollbar-thumb:hover {\n                    background: var(--primary-hover);\n                }\n            </style>\n            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">\n                \x3c!-- Left Column --\x3e\n                <div style="display:flex;flex-direction:column;gap:1rem;">\n                    <div style="display:flex;justify-content:space-between;align-items:center;padding:0.5rem;background:rgba(255,255,255,0.05);border-radius:8px;">\n                        <span style="color:var(--text-dim);">Latest Version:</span>\n                        <span style="color:var(--text-light);font-weight:500;">${t}</span>\n                    </div>\n                    <div style="display:flex;justify-content:space-between;align-items:center;padding:0.5rem;background:rgba(255,255,255,0.05);border-radius:8px;">\n                        <span style="color:var(--text-dim);">Current Version:</span>\n                        <span style="color:var(--text-light);font-weight:500;">${o}</span>\n                    </div>\n                    <div style="display:flex;justify-content:space-between;align-items:center;padding:0.5rem;background:rgba(255,255,255,0.05);border-radius:8px;">\n                        <span style="color:var(--text-dim);">LLM Model:</span>\n                        <span style="color:var(--text-light);font-weight:500;">${a}</span>\n                    </div>\n                </div>\n                \n                \x3c!-- Right Column --\x3e\n                <div style="display:flex;flex-direction:column;gap:1rem;">\n                    <div style="display:flex;justify-content:space-between;align-items:center;padding:0.5rem;background:rgba(255,255,255,0.05);border-radius:8px;">\n                        <span style="color:var(--text-dim);">Release Type:</span>\n                        <span style="color:var(--text-light);font-weight:500;">${n}</span>\n                    </div>\n                    <div style="display:flex;justify-content:space-between;align-items:center;padding:0.5rem;background:rgba(255,255,255,0.05);border-radius:8px;">\n                        <span style="color:var(--text-dim);">Version Code:</span>\n                        <span style="color:var(--text-light);font-weight:500;">${i}</span>\n                    </div>\n                </div>\n            </div>\n\n            \x3c!-- Full Width Items --\x3e\n            <div style="display:flex;flex-direction:column;gap:1rem;">\n                <div style="display:flex;justify-content:space-between;align-items:center;padding:0.5rem;background:rgba(255,255,255,0.05);border-radius:8px;">\n                    <span style="color:var(--text-dim);">Device ID:</span>\n                    <span style="color:var(--text-light);font-weight:500;font-family:monospace;">${r}</span>\n                </div>\n                <div style="display:flex;justify-content:space-between;align-items:center;padding:0.5rem;background:rgba(255,255,255,0.05);border-radius:8px;">\n                    <span style="color:var(--text-dim);">Operating System:</span>\n                    <span style="color:var(--text-light);font-weight:500;">${d}</span>\n                </div>\n            </div>\n            ${p}\n        </div>\n    `,proGlow:!1}),l&&setTimeout((()=>{const e=document.getElementById(c);if(e){window.resizeIframe(e);try{const t=e.contentDocument||e.contentWindow.document;new MutationObserver((()=>{window.resizeIframe(e)})).observe(t.body,{childList:!0,subtree:!0,characterData:!0})}catch(e){}}}),50)}function handleHistoryClick(){window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.get_chat_history?window.pywebview.api.get_chat_history().then((e=>{if(e.success){const t=e.history;let n="",o=0===t.length,i=o?"showToast({message: 'There is nothing to clear! Your chat history is already empty.',duration: 3000})":"showClearHistoryConfirmation()",a=o?"showToast({message: 'There is nothing to summarize! Your chat history is already empty.',duration: 3000})":"summarizeHistoryPopup()";n=o?'\n                            <div style="\n                                display: flex;\n                                flex-direction: column;\n                                align-items: center;\n                                justify-content: center;\n                                height: 40vh;\n                                background: transparent;\n                                border-radius: 16px;\n                                gap: 0.5rem;\n                                margin-top: 2rem;\n                            ">\n                                <div style="\n                                    font-size: 4rem;\n                                    color: #a3a3a3;\n                                    margin-bottom: 0.5rem;\n                                ">ðŸ˜”</div>\n                                <div style="\n                                    font-size: 2rem;\n                                    font-weight: 600;\n                                    color: #d1d5db;\n                                    margin-bottom: 0.5rem;\n                                    text-align: center;\n                                ">It feels lonely here...</div>\n                                <div style="\n                                    font-size: 1.1rem;\n                                    color: #a3a3a3;\n                                    text-align: center;\n                                ">No history record found</div>\n                            </div>\n                        ':t.map(((e,t)=>{const n="user"===e.role?"var(--primary-color)":"var(--secondary-color)";let o="";if(e.timestamp){let t=new Date(e.timestamp);if(!isNaN(t.getTime())){o=`<div style="color:#a3a3a3;font-size:0.85rem;margin-bottom:0.5rem;">${t.toLocaleDateString()} &bull; ${t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}</div>`}}const i=e.parts&&e.parts[0]&&e.parts[0].text?e.parts[0].text:"";return`\n                                <div class="history-item" style="\n                                    background: rgba(255,255,255,0.05);\n                                    border-radius: 12px;\n                                    padding: 1rem;\n                                    border: 1px solid rgba(255,255,255,0.1);\n                                    transition: all 0.2s ease;\n                                    margin-bottom: 1rem;\n                                " data-markdown="${encodeURIComponent(i)}">\n                                    <div style="\n                                        display: flex;\n                                        justify-content: space-between;\n                                        align-items: center;\n                                        margin-bottom: 0.75rem;\n                                        padding-bottom: 0.5rem;\n                                        border-bottom: 1px solid rgba(255,255,255,0.1);\n                                    ">\n                                        <div style="\n                                            display: flex;\n                                            align-items: center;\n                                            gap: 0.5rem;\n                                        ">\n                                            <div style="\n                                                width: 8px;\n                                                height: 8px;\n                                                border-radius: 50%;\n                                                background: ${n};\n                                                box-shadow: 0 0 8px ${n};\n                                            "></div>\n                                            <span style="\n                                                color: ${n};\n                                                font-weight: 600;\n                                                font-size: 0.9rem;\n                                                text-transform: uppercase;\n                                                letter-spacing: 0.5px;\n                                            ">${e.role}</span>\n                                        </div>\n                                        <span style="\n                                            color: var(--text-dim);\n                                            font-size: 0.8rem;\n                                        ">#${t+1}</span>\n                                    </div>\n                                    ${o}\n                                    <div class="message-text" style="color: var(--text-light);font-size: 0.95rem;line-height: 1.5;white-space: pre-wrap;word-break: break-word;">${marked.parse(i)}</div>\n                                    <div class="message-bubble-actions" style="margin-top:0.75rem;display:flex;gap:0.5rem;justify-content:flex-end;">\n                                        <button class="icon-btn history-copy-btn" title="Copy markdown"><i class="fad fa-copy"></i></button>\n                                        <button class="icon-btn history-maximize-btn" title="Maximize"><i class="fad fa-expand-arrows"></i></button>\n                                    </div>\n                                </div>\n                            `})).join(""),showPopupBelowHeader({title:"Chat History",contentHtml:`\n                            <div style="\n                                display: flex;\n                                flex-direction: column;\n                                gap: 1rem;\n                                min-width: 70%;\n                                padding: 1.5rem;\n                                max-width: 95%;\n                                max-height: 80vh;\n                                overflow-y: auto;\n                                scrollbar-width: thin;\n                                scrollbar-color: var(--primary-color) rgba(255,255,255,0.1);\n                                background: rgba(13, 2, 33, 0.95);\n                                border-radius: 16px;\n                                border: 1px solid rgba(255,255,255,0.1);\n                                box-shadow: 0 8px 32px rgba(0,0,0,0.2);\n                            ">\n                                <div style="\n                                    display: flex;\n                                    justify-content: flex-start;\n                                    gap: 0.5rem;\n                                    margin-bottom: 1rem;\n                                ">\n                                    <button onclick="${i}" style="\n                                        background: rgba(239, 68, 68, 0.1);\n                                        color: #ef4444;\n                                        border: 1px solid rgba(239, 68, 68, 0.3);\n                                        padding: 0.5rem 1rem;\n                                        border-radius: 8px;\n                                        font-weight: 500;\n                                        cursor: pointer;\n                                        transition: all 0.2s ease;\n                                        display: flex;\n                                        align-items: center;\n                                        gap: 0.5rem;\n                                    ">\n                                        <i class="fas fa-trash-alt"></i>\n                                        Clear History\n                                    </button>\n                                    <button onclick="${a}" style="\n                                        background: rgba(99, 102, 241, 0.1);\n                                        color: #6366f1;\n                                        border: 1px solid rgba(99, 102, 241, 0.3);\n                                        padding: 0.5rem 1rem;\n                                        border-radius: 8px;\n                                        font-weight: 500;\n                                        cursor: pointer;\n                                        transition: all 0.2s ease;\n                                        display: flex;\n                                        align-items: center;\n                                        gap: 0.5rem;\n                                    ">\n                                        <i class="fas fa-scroll"></i>\n                                        Summarize History\n                                    </button>\n                                </div>\n                                <style>\n                                    .history-container::-webkit-scrollbar {\n                                        width: 8px;\n                                    }\n                                    .history-container::-webkit-scrollbar-track {\n                                        background: rgba(255,255,255,0.1);\n                                        border-radius: 4px;\n                                    }\n                                    .history-container::-webkit-scrollbar-thumb {\n                                        background: var(--primary-color);\n                                        border-radius: 4px;\n                                    }\n                                    .history-container::-webkit-scrollbar-thumb:hover {\n                                        background: var(--primary-hover);\n                                    }\n                                    .history-item:hover {\n                                        transform: translateY(-2px);\n                                        box-shadow: 0 4px 12px rgba(0,0,0,0.2);\n                                        border-color: rgba(255,255,255,0.2);\n                                    }\n                                </style>\n                                <div class="history-container" style="\n                                    display: flex;\n                                    flex-direction: column;\n                                    gap: 1rem;\n                                ">\n                                    ${n}\n                                </div>\n                            </div>\n                        `,proGlow:!1}),setTimeout((()=>{document.querySelectorAll(".history-item").forEach((e=>{const t=decodeURIComponent(e.getAttribute("data-markdown")||""),n=e.querySelector(".history-copy-btn"),o=e.querySelector(".history-maximize-btn");n&&(n.onclick=function(){navigator.clipboard.writeText(t).then((()=>{showToast({message:"Copied to clipboard!",type:"success",duration:2e3})}))}),o&&(o.onclick=function(){showMaximizePopup(t)})}))}),10),window.summarizeHistoryPopup=function(){showHistorySummaryPopup(t)}}else showToast({message:e.message||"Failed to load chat history",type:"error",duration:3e3})})).catch((e=>{showToast({message:"Failed to load chat history",type:"error",duration:3e3})})):showToast({message:"Unable to load chat history",type:"error",duration:3e3})}function showHistorySummaryPopup(e){const t=document.createElement("div");t.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0,0,0,0.55);\n        backdrop-filter: blur(6px);\n        z-index: 2000;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n    ";const n=document.createElement("div");n.style.cssText="\n        background: rgba(20, 16, 40, 0.98);\n        border-radius: 18px;\n        padding: 2rem 2.5rem;\n        min-width: 340px;\n        max-width: 90vw;\n        max-height: 80vh;\n        color: #fff;\n        box-shadow: 0 8px 32px rgba(0,0,0,0.25);\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        position: relative;\n        overflow-y: auto;\n    ",n.innerHTML='\n        <div style="font-size:1.3rem;font-weight:600;margin-bottom:1.2rem;text-align:center;">Generating history summary...</div>\n        <div class="thinking-animation" style="margin-bottom:1.5rem;">\n            <div class="thinking-dot"></div>\n            <div class="thinking-dot"></div>\n            <div class="thinking-dot"></div>\n        </div>\n        <div id="history-summary-content" style="font-size:1.05rem;line-height:1.6;text-align:left;"></div>\n        <button id="close-summary-popup" style="margin-top:2rem;background:rgba(255,255,255,0.08);color:#fff;border:none;padding:0.6rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">Close</button>\n    ',t.appendChild(n),document.body.appendChild(t),document.getElementById("close-summary-popup").onclick=()=>t.remove();const o={text:`Generate a detailed summary of the following chat history. The history is provided as a JSON array. Please provide a comprehensive, human-readable summary.\n\n${JSON.stringify(e,null,2)}`};if(window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.generate_responce)window.pywebview.api.generate_responce(JSON.stringify(o)).then((e=>{const t=document.getElementById("history-summary-content");e.success&&e.response?(t.innerHTML=`<div style='white-space:pre-line;'>${e.response}</div>`,n.querySelector(".thinking-animation").style.display="none",n.querySelector("div").textContent="Chat History Summary"):(t.innerHTML=`<span style='color:#ef4444;'>${e.message||"Failed to generate summary."}</span>`,n.querySelector(".thinking-animation").style.display="none",n.querySelector("div").textContent="Error")})).catch((e=>{document.getElementById("history-summary-content").innerHTML=`<span style='color:#ef4444;'>${e.message||"Failed to generate summary."}</span>`,n.querySelector(".thinking-animation").style.display="none",n.querySelector("div").textContent="Error"}));else{document.getElementById("history-summary-content").innerHTML="<span style='color:#ef4444;'>Python API not available.</span>",n.querySelector(".thinking-animation").style.display="none",n.querySelector("div").textContent="Error"}}function handleMemoryClick(){showToast({message:"AI Memory : This feature is currently under development and will be available in future updates.",type:"info",duration:3e3})}function handleAccountClick(){const e=window.APP_CONFIG||APP_CONFIG;if(!e||!e.user)return void addMessageToChat({sender:"System",text:"User info not available.",isUser:!1});const t=e.user;const n=t.name||"",o=t.date_of_birth||"",i=t.gender||"",a=function(e){if(!e||"string"!=typeof e)return"";const[t,n]=e.split("@");return t&&n?t.length<=4?t[0]+"**"+t.slice(-1)+"@"+n:t.slice(0,2)+"*".repeat(Math.max(0,t.length-4))+t.slice(-2)+"@"+n:e}(t.email||"");var r;showPopupBelowHeader({title:"Account Information",contentHtml:`\n        <div style="display:flex;align-items:center;gap:2.5rem;min-width:400px;">\n            <div style="flex-shrink:0;">\n                <img src="${(r=t.avatar)&&"null"!==r&&null!==r&&isValidHttpUrl(r)?r:"./assets/avatar_defolt.gif"}" alt="Avatar" style="width:96px;height:96px;border-radius:50%;border:3px solid #6366f1;object-fit:cover;background:#222;" onerror="this.onerror=null;this.src='./assets/avatar_defolt.gif'">\n            </div>\n            <div style="flex:1;display:flex;flex-direction:column;gap:0.7rem;font-size:1.1rem;">\n                <div><b>Name:</b> <span style="color:#fff;">${n}</span></div>\n                <div><b>Date of Birth:</b> <span style="color:#fff;">${o}</span></div>\n                <div><b>Gender:</b> <span style="color:#fff;">${i}</span></div>\n                <div><b>Email:</b> <span style="color:#fff;">${a}</span></div>\n            </div>\n        </div>\n        <div style="margin-top:1.5rem;text-align:center;">\n            <button onclick="openExternalLink('https://auth.dkydivyansh.com/dashboard/profile')" style="background:linear-gradient(to right,#6366f1,#4f46e5);color:white;border:none;padding:0.5rem 1rem;border-radius:0.5rem;cursor:pointer;font-weight:500;transition:all 0.2s ease;box-shadow:0 2px 4px rgba(0,0,0,0.2);">\n                Manage Profile\n            </button>\n        </div>\n    `,proGlow:!1})}function handleLogoutClick(){closePopupBelowHeader();showPopupBelowHeader({title:"Logout",contentHtml:'\n        <div style="display:flex;flex-direction:column;align-items:center;gap:1.5rem;min-width:340px;max-width:95vw;">\n            <i style="font-size:2.5rem;" class="fad fa-sign-out"></i>\n            <div style="font-size:1.3rem;font-weight:600;text-align:center;">Logging out will clear your local data including chat history.<br><span style=\'color:#f59e42;font-size:1.05rem;\'>Long-term memory will <b>not</b> be affected.</span></div>\n            <div style="color:#a3a3a3;font-size:1.05rem;text-align:center;">It\'s a good idea to backup your data before logging out.</div>\n            <div style="display:flex;gap:1.2rem;justify-content:center;margin-top:0.5rem;">\n                <button id="logout-backup-btn" style="background:linear-gradient(90deg,#6366f1,#4f46e5);color:white;border:none;padding:0.7rem 1.5rem;border-radius:0.7rem;font-weight:500;cursor:pointer;transition:all 0.2s;box-shadow:0 2px 8px rgba(99,102,241,0.12);">Backup</button>\n                <button id="logout-logout-btn" style="background:#ef4444;color:white;border:none;padding:0.7rem 1.5rem;border-radius:0.7rem;font-weight:500;cursor:pointer;transition:all 0.2s;box-shadow:0 2px 8px rgba(239,68,68,0.12);">Logout</button>\n            </div>\n        </div>\n    ',proGlow:!1}),setTimeout((()=>{const e=document.getElementById("logout-backup-btn"),t=document.getElementById("logout-logout-btn");e&&(e.onclick=function(){const e=document.createElement("div");e.style.cssText="\n                    position: fixed;\n                    top: 0;\n                    left: 0;\n                    right: 0;\n                    bottom: 0;\n                    background: rgba(0,0,0,0.7);\n                    backdrop-filter: blur(4px);\n                    z-index: 2000;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                ";const t=document.createElement("div");t.style.cssText="\n                    background: rgba(20, 16, 40, 0.98);\n                    border-radius: 14px;\n                    padding: 2rem;\n                    width: 95vw;\n                    max-width: 420px;\n                    color: white;\n                    text-align: center;\n                    box-shadow: 0 8px 32px rgba(0,0,0,0.25);\n                ",t.innerHTML='\n                    <div style="margin-bottom: 1.5rem;">\n                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #6366f1; margin-bottom: 1rem;"></i>\n                        <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">Creating Backup</h3>\n                        <p style="color: var(--text-medium);">Please wait while we prepare your backup...</p>\n                    </div>\n                ',e.appendChild(t),document.body.appendChild(e),window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.backup_data?window.pywebview.api.backup_data().then((n=>{if(e.remove(),n&&n.success){const o=document.createElement("div");o.style.cssText=e.style.cssText;const i=document.createElement("div");i.style.cssText=t.style.cssText,i.innerHTML='\n                                <div style="margin-bottom: 1.5rem;">\n                                    <i class="fas fa-check-circle" style="font-size: 2rem; color: #10b981; margin-bottom: 1rem;"></i>\n                                    <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">Backup Created</h3>\n                                    <p style="color: var(--text-medium);">Your backup is ready to be saved.</p>\n                                    <p style="color: red;"> This backup is encrypted with your current account credentials; it will only be restored to the same account.</p>\n\n                                </div>\n                                <div style="display: flex; gap: 1rem; justify-content: center;">\n                                    <button id="save-backup-btn" style="background: #10b981; color: white; border: none; padding: 0.7rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">Save Backup</button>\n                                    <button id="close-backup-btn" style="background: rgba(255,255,255,0.1); color: var(--text-light); border: 1px solid rgba(255,255,255,0.2); padding: 0.7rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">Close</button>\n                                </div>\n                            ',o.appendChild(i),document.body.appendChild(o),document.getElementById("save-backup-btn").onclick=function(){const e=`emilyx64_backup_${(new Date).toISOString().replace(/[:.]/g,"-")}`;window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.save_file?window.pywebview.api.save_file(e,n.data).then((e=>{e&&e.success?showToast({message:"Backup saved successfully!",type:"success",duration:3e3}):showToast({message:e.message||"Failed to save backup.",type:"error",duration:4e3}),o.remove()})).catch((e=>{showToast({message:"Failed to save backup.",type:"error",duration:4e3}),o.remove()})):(showToast({message:"Save function not available.",type:"error",duration:4e3}),o.remove())},document.getElementById("close-backup-btn").onclick=function(){o.remove()}}else showToast({message:n.message||"Failed to create backup.",type:"error",duration:4e3})})).catch((t=>{e.remove(),showToast({message:"Failed to create backup.",type:"error",duration:4e3})})):(e.remove(),showToast({message:"Backup function not available.",type:"error",duration:4e3}))}),t&&(t.onclick=function(){showLogoutConfirmationPopup()})}),10)}function showLogoutConfirmationPopup(){closePopupBelowHeader();const e=document.createElement("div");e.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0,0,0,0.7);\n        backdrop-filter: blur(4px);\n        z-index: 2000;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n    ";const t=document.createElement("div");t.style.cssText="\n        background: rgba(239, 68, 68, 0.13);\n        border: 1px solid rgba(239, 68, 68, 0.3);\n        border-radius: 14px;\n        padding: 2rem 2.2rem 1.5rem 2.2rem;\n        width: 95vw;\n        max-width: 420px;\n        color: white;\n        text-align: center;\n        box-shadow: 0 8px 32px rgba(239,68,68,0.13);\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n    ",t.innerHTML='\n        <div style="margin-bottom: 1.2rem;">\n            <i class="fas fa-exclamation-triangle" style="color: #ef4444; font-size: 2.2rem; margin-bottom: 0.7rem;"></i>\n            <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem; color: #ef4444;">Confirm Logout</h3>\n            <p style="color: var(--text-medium); line-height: 1.5;">This will clear all your local data and close the application.<br>Type <b>conform logout</b> below to continue.</p>\n        </div>\n        <input id="logout-confirm-input" type="text" placeholder="Type: conform logout" style="width:100%;padding:0.7rem 1rem;border-radius:8px;border:1px solid #ef4444;background:rgba(255,255,255,0.08);color:#fff;font-size:1rem;margin-bottom:1.2rem;outline:none;" />\n        <div id="logout-confirm-error" style="color:#ef4444;font-size:0.98rem;margin-bottom:1.2rem;display:none;"></div>\n        <div style="display:flex;gap:1rem;justify-content:center;">\n            <button id="logout-cancel-btn" style="background:rgba(255,255,255,0.1);color:var(--text-light);border:1px solid rgba(255,255,255,0.2);padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">Close</button>\n            <button id="logout-continue-btn" style="background:#ef4444;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">Continue</button>\n        </div>\n    ',e.appendChild(t),document.body.appendChild(e),document.getElementById("logout-cancel-btn").onclick=()=>e.remove(),document.getElementById("logout-continue-btn").onclick=()=>{const t=document.getElementById("logout-confirm-input").value.trim().toLowerCase(),n=document.getElementById("logout-confirm-error");if("conform logout"!==t)return n.textContent='Please type "conform logout" to confirm.',void(n.style.display="block");n.style.display="none",e.remove(),window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.clear_session_close?(showLoadingWindow("Logging out and clearing data..."),window.pywebview.api.clear_session_close().then((e=>{e.success||(removeLoadingWindow(),showToast({message:e.message||"Failed to logout.",type:"error",duration:4e3}))})).catch((e=>{removeLoadingWindow(),showToast({message:"Failed to logout.",type:"error",duration:4e3})}))):showToast({message:"Logout function not available.",type:"error",duration:4e3})},document.getElementById("logout-confirm-input").addEventListener("input",(function(){document.getElementById("logout-confirm-error").style.display="none"}))}function handleSettingsClick(){const e=((window.APP_CONFIG||APP_CONFIG||DEFAULT_CONFIG)["user-type"]||"free").toLowerCase();showPopupBelowHeader({title:"Settings",contentHtml:`\n        <div style="display:grid;grid-template-columns:1fr 1fr;gap:2rem 3rem;font-size:1.15rem;">\n            <div style="text-align:left;">\n                <label for="languageSelect" style="display:block;margin-bottom:0.5rem;color:var(--text-light);">Voice Recognition Language</label>\n                <select id="languageSelect" style="width:100%;padding:0.5rem;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;">\n                    <option value="en-US">English (US)</option>\n                    <option value="en-GB">English (UK)</option>\n                    <option value="en-IN">English (India)</option>\n                    <option value="hi-IN">Hindi</option>\n                    <option value="es-ES">Spanish</option>\n                    <option value="fr-FR">French</option>\n                    <option value="de-DE">German</option>\n                    <option value="it-IT">Italian</option>\n                    <option value="ja-JP">Japanese</option>\n                    <option value="ko-KR">Korean</option>\n                    <option value="zh-CN">Chinese (Simplified)</option>\n                    <option value="ru-RU">Russian</option>\n                    <option value="pt-BR">Portuguese (Brazil)</option>\n                    <option value="nl-NL">Dutch</option>\n                    <option value="tr-TR">Turkish</option>\n                    <option value="pl-PL">Polish</option>\n                    <option value="ar-SA">Arabic</option>\n                    <option value="he-IL">Hebrew</option>\n                    <option value="id-ID">Indonesian</option>\n                    <option value="th-TH">Thai</option>\n                    <option value="vi-VN">Vietnamese</option>\n                    <option value="sv-SE">Swedish</option>\n                    <option value="da-DK">Danish</option>\n                    <option value="fi-FI">Finnish</option>\n                    <option value="el-GR">Greek</option>\n                    <option value="cs-CZ">Czech</option>\n                    <option value="hu-HU">Hungarian</option>\n                    <option value="ro-RO">Romanian</option>\n                    <option value="sk-SK">Slovak</option>\n                    <option value="uk-UA">Ukrainian</option>\n                    <option value="hr-HR">Croatian</option>\n                    <option value="bg-BG">Bulgarian</option>\n                    <option value="sr-RS">Serbian</option>\n                    <option value="sl-SI">Slovenian</option>\n                    <option value="et-EE">Estonian</option>\n                    <option value="lv-LV">Latvian</option>\n                    <option value="lt-LT">Lithuanian</option>\n                </select>\n            </div>\n            <div style="text-align:left;">\n                <label for="aiSpeechSelect" style="display:block;margin-bottom:0.5rem;color:var(--text-light);">Enable AI Speech</label>\n                <div style="position:relative;">\n                    <select id="aiSpeechSelect" style="width:100%;padding:0.5rem;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;${"free"===e?"opacity:0.5;pointer-events:none;":""}">\n                        <option value="true">True</option>\n                        <option value="false">False</option>\n                    </select>\n                    ${"free"===e?'<div style="position:absolute;top:100%;left:0;margin-top:0.5rem;color:#ffd700;font-size:0.9rem;">Available with Pro subscription</div>':""}\n                </div>\n            </div>\n        </div>\n        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:2rem;">\n            <button id="viewEditAppBtn" style="background:#222;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">View/Edit App Opening</button>\n            <button id="manageHaBtn" style="background:#222;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">Manage Home Assistant</button>\n            <button id="restoreDataBtn" style="background:#222;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">Restore Data</button>\n            <button id="saveSettingsBtn" style="background:#6366f1;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">Save Changes</button>\n        </div>\n    `,proGlow:"PRO"===e}),document.getElementById("languageSelect").value=userLang,document.getElementById("aiSpeechSelect").value=String(isvoiseactive),document.getElementById("saveSettingsBtn").onclick=saveSettings,document.getElementById("viewEditAppBtn").onclick=showAppListPopup,document.getElementById("manageHaBtn").onclick=showHomeAssistantPopup,document.getElementById("restoreDataBtn").onclick=handleRestoreDataClick}function showAppListPopup(){showLoadingWindow("Loading app list..."),window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.get_app_data?window.pywebview.api.get_app_data().then((e=>{removeLoadingWindow();let t=null;try{t=e?JSON.parse(e):null}catch(e){t=null}if(t&&Array.isArray(t.apps)&&0!==t.apps.length){let e="<div style='max-height:60vh;overflow:auto;'>";e+="<table style='width:100%;border-collapse:collapse;'>",e+="<thead><tr><th style='text-align:left;padding:8px;'>Name</th><th style='text-align:left;padding:8px;'>Path</th><th style='text-align:left;padding:8px;'>Arguments</th><th style='padding:8px;'>Test</th></tr></thead><tbody>";for(const n of t.apps)e+=`<tr>\n                            <td style='padding:8px;'>${escapeHtml(n.name)}</td>\n                            <td style='padding:8px;'>${escapeHtml(n.path)}</td>\n                            <td style='padding:8px;'>${Array.isArray(n.arguments)?n.arguments.map(escapeHtml).join(" "):""}</td>\n                            <td style='padding:8px;'><button class='testAppBtn' data-code='${n.code}' style='background:#222;color:white;border:none;padding:0.3rem 1rem;border-radius:6px;cursor:pointer;'>Test</button></td>\n                        </tr>`;e+="</tbody></table></div>",e+="<div style='display:flex;justify-content:flex-end;margin-top:1.5rem;'><button id='editAppListBtn' style='background:#6366f1;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;'>Edit</button></div>",showPopupBelowHeader({title:"App Opening List",contentHtml:e,onClose:closePopupBelowHeader}),setTimeout((()=>{const e=document.getElementById("editAppListBtn");e&&(e.onclick=()=>{showAppEditPopup(t)}),document.querySelectorAll(".testAppBtn").forEach((e=>{e.onclick=function(){const e=this.getAttribute("data-code"),n=t.apps.find((t=>t.code===e));n&&testAppLaunch(n)}}))}),100)}else showPopupBelowHeader({title:"App Opening List",contentHtml:"<div style=\"padding:2rem;text-align:center;\"><div style='color:#ffd700;margin-bottom:1rem;'>No apps found. Start by adding an app. Click on <b>Edit</b>.</div><button id='editAppListBtn' style='margin-top:1.5rem;background:#6366f1;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;'>Add New</button></div>",onClose:closePopupBelowHeader}),setTimeout((()=>{const e=document.getElementById("editAppListBtn");e&&(e.onclick=()=>{showAppEditPopup({apps:[]})})}),100)})).catch((e=>{removeLoadingWindow(),showToast({message:"Failed to load app list",type:"error"})})):(removeLoadingWindow(),showToast({message:"Backend not available",type:"error"}))}function showAppEditPopup(e){let t=JSON.parse(JSON.stringify(e));Array.isArray(t.apps)||(t.apps=[]);let n=!1;!function o(){for(let e=0;e<t.apps.length;++e){const n=document.querySelector(`.editAppName[data-idx='${e}']`),o=document.querySelector(`.editAppPath[data-idx='${e}']`),i=document.querySelector(`.editAppArgs[data-idx='${e}']`);if(n&&(t.apps[e].name=n.value),o&&(t.apps[e].path=o.value),i){let n=i.value.trim();t.apps[e].arguments=n&&n.match(/(?:[^\s"]+|"[^"]*")+/g)||[]}}let i="<div style='max-height:60vh;overflow:auto;'>";i+="<div style='background:#222;color:#ffd700;padding:10px 16px;border-radius:8px;margin-bottom:12px;font-size:0.98rem;'>\n            <b>Note:</b> App name is <b>required</b>, must be <b>unique</b>, and can only contain <b>capital letters (A-Z)</b>, <b>numbers (0-9)</b>, and <b>underscores (_)</b>.\n        </div>",i+="<table style='width:100%;border-collapse:collapse;'>",i+="<thead><tr><th style='text-align:left;padding:8px;'>Name</th><th style='text-align:left;padding:8px;'>Path</th><th style='text-align:left;padding:8px;'>Arguments</th><th style='padding:8px;'>Test</th><th style='padding:8px;'>Delete</th></tr></thead><tbody>";for(let e=0;e<t.apps.length;++e){const n=t.apps[e];i+=`<tr>\n                <td style='padding:8px;'><input type='text' maxlength='20' value='${escapeHtml(n.name)}' data-idx='${e}' class='editAppName' style='width:120px;background:#111;color:#fff;border:1px solid #444;border-radius:5px;padding:4px;'/></td>\n                <td style='padding:8px;'><input type='text' value='${escapeHtml(n.path)}' data-idx='${e}' class='editAppPath' style='width:220px;background:#111;color:#fff;border:1px solid #444;border-radius:5px;padding:4px;'/></td>\n                <td style='padding:8px;'><input type='text' value='${Array.isArray(n.arguments)?n.arguments.map(escapeHtml).join(" "):""}' data-idx='${e}' class='editAppArgs' style='width:120px;background:#111;color:#fff;border:1px solid #444;border-radius:5px;padding:4px;' placeholder='Optional'/></td>\n                <td style='padding:8px;'><button class='testAppBtn' data-idx='${e}' style='background:#222;color:white;border:none;padding:0.3rem 1rem;border-radius:6px;cursor:pointer;'>Test</button></td>\n                <td style='padding:8px;'><button class='deleteAppBtn' data-idx='${e}' style='background:#c00;color:white;border:none;padding:0.3rem 1rem;border-radius:6px;cursor:pointer;'>Delete</button></td>\n            </tr>`}i+="</tbody></table></div>",i+="<div style='display:flex;justify-content:space-between;margin-top:1.5rem;gap:1rem;'>\n            <div><button id='backToAppListBtn' style='background:#444;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;'>Back</button></div>\n            <div>\n                <button id='addAppBtn' style='background:#222;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;'>Add App</button>\n                <button id='saveAppListBtn' style='background:#6366f1;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;margin-left:0.5rem;'>Save</button>\n            </div>\n        </div>",showPopupBelowHeader({title:"Edit App Opening List",contentHtml:i,onClose:closePopupBelowHeader}),setTimeout((()=>{document.getElementById("backToAppListBtn").onclick=()=>showAppListPopup(),document.getElementById("addAppBtn").onclick=()=>{for(let e=0;e<t.apps.length;++e){const n=document.querySelector(`.editAppName[data-idx='${e}']`),o=document.querySelector(`.editAppPath[data-idx='${e}']`),i=document.querySelector(`.editAppArgs[data-idx='${e}']`);if(n&&(t.apps[e].name=n.value),o&&(t.apps[e].path=o.value),i){let n=i.value.trim();t.apps[e].arguments=n&&n.match(/(?:[^\s"]+|"[^"]*")+/g)||[]}}if(t.apps.length>=20)return void showToast({message:"Maximum 20 apps allowed",type:"warning"});const e=Math.random().toString().slice(2,8);t.apps.push({name:"",code:e,path:"",arguments:[]}),n=!0,o()},document.getElementById("saveAppListBtn").onclick=()=>{for(let e=0;e<t.apps.length;++e){const n=document.querySelector(`.editAppName[data-idx='${e}']`),o=document.querySelector(`.editAppPath[data-idx='${e}']`),i=document.querySelector(`.editAppArgs[data-idx='${e}']`);if(n&&(t.apps[e].name=n.value),o&&(t.apps[e].path=o.value),i){let n=i.value.trim();t.apps[e].arguments=n&&n.match(/(?:[^\s"]+|"[^"]*")+/g)||[]}}let n=!0,o="";const i=new Set;for(let e=0;e<t.apps.length;++e){const a=t.apps[e];if(!a.name){n=!1,o=`App #${e+1}: Name is required.`;break}if(!/^[A-Z0-9_]+$/.test(a.name)){n=!1,o=`App #${e+1}: Name must use only capital letters (A-Z), numbers (0-9), and underscores (_).`;break}if(i.has(a.name)){n=!1,o=`App #${e+1}: Duplicate app name '${a.name}' is not allowed.`;break}if(i.add(a.name),!a.path){n=!1,o=`App #${e+1}: Path is required.`;break}}if(n){if(!(t.apps.length>20))return JSON.stringify(t)===JSON.stringify(e)?(showToast({message:"No changes made",type:"info"}),void closePopupBelowHeader()):void showConfirmAppSave(t);showToast({message:"Maximum 20 apps allowed",type:"warning"})}else showToast({message:o||"Please fill all fields (name and path required)",type:"error"})},document.querySelectorAll(".deleteAppBtn").forEach((e=>{e.onclick=function(){for(let e=0;e<t.apps.length;++e){const n=document.querySelector(`.editAppName[data-idx='${e}']`),o=document.querySelector(`.editAppPath[data-idx='${e}']`),i=document.querySelector(`.editAppArgs[data-idx='${e}']`);if(n&&(t.apps[e].name=n.value),o&&(t.apps[e].path=o.value),i){let n=i.value.trim();t.apps[e].arguments=n&&n.match(/(?:[^\s"]+|"[^"]*")+/g)||[]}}const e=parseInt(this.getAttribute("data-idx"));t.apps.splice(e,1),n=!0,o()}})),document.querySelectorAll(".testAppBtn").forEach((e=>{e.onclick=function(){for(let e=0;e<t.apps.length;++e){const n=document.querySelector(`.editAppName[data-idx='${e}']`),o=document.querySelector(`.editAppPath[data-idx='${e}']`),i=document.querySelector(`.editAppArgs[data-idx='${e}']`);if(n&&(t.apps[e].name=n.value),o&&(t.apps[e].path=o.value),i){let n=i.value.trim();t.apps[e].arguments=n&&n.match(/(?:[^\s"]+|"[^"]*")+/g)||[]}}const e=parseInt(this.getAttribute("data-idx")),n=t.apps[e];n&&testAppLaunch(n)}})),document.querySelectorAll(".editAppName").forEach((e=>{e.addEventListener("input",(function(){let e=this.value.toUpperCase().replace(/[^A-Z0-9_]/g,"");e.length>20&&(e=e.slice(0,20)),this.value!==e&&(this.value=e)}))}))}),100)}()}function showConfirmAppSave(e){const t=document.createElement("div");t.id="app-save-confirm-overlay",t.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;z-index:2000;background:rgba(0,0,0,0.55);backdrop-filter:blur(6px);align-items:center;justify-content:center;display:flex;";const n=document.createElement("div");n.style.cssText="background:rgba(20,16,40,0.98);border-radius:18px;padding:2rem 2.5rem;min-width:320px;max-width:90vw;color:#fff;box-shadow:0 8px 32px rgba(0,0,0,0.25);display:flex;flex-direction:column;align-items:center;",n.innerHTML="<div style='font-size:1.2rem;font-weight:600;margin-bottom:1.2rem;text-align:center;'>Save App List?</div><div style='font-size:1.05rem;line-height:1.6;text-align:center;margin-bottom:2rem;'>After saving, the application will restart.</div><div style='display:flex;gap:1.5rem;justify-content:center;'><button id='app-save-cancel' style='background:rgba(255,255,255,0.1);color:var(--text-light);border:1px solid rgba(255,255,255,0.2);padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;'>Cancel</button><button id='app-save-continue' style='background:#6366f1;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;'>Save</button></div>",t.appendChild(n),document.body.appendChild(t),document.getElementById("app-save-cancel").onclick=()=>t.remove(),document.getElementById("app-save-continue").onclick=()=>{t.remove(),showLoadingWindow("Saving app list and restarting..."),window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.save_app_data?window.pywebview.api.save_app_data(JSON.stringify(e)).then((e=>{})).catch((e=>{removeLoadingWindow(),showToast({message:"Failed to save app list",type:"error"})})):(removeLoadingWindow(),showToast({message:"Backend not available",type:"error"}))}}function testAppLaunch(e){e&&e.path&&e.path.toLowerCase().endsWith(".exe")?(showLoadingWindow("Testing app launch..."),window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.launch_hidden?window.pywebview.api.launch_hidden(e.path,e.arguments||[]).then((e=>{removeLoadingWindow(),!0===e||e&&!1!==e.success?showToast({message:"App launched (check your screen)",type:"success"}):showToast({message:"Failed to launch app",type:"error"})})).catch((e=>{removeLoadingWindow(),showToast({message:"Failed to launch app",type:"error"})})):(removeLoadingWindow(),showToast({message:"Backend not available",type:"error"}))):showToast({message:"Invalid app path",type:"error"})}async function isHomeAssistantUp(e,t){const n=`${e.replace(/\/+$/,"")}/api/`;try{return(await fetch(n,{headers:{Authorization:`Bearer ${t}`},method:"GET"})).ok}catch(e){return!1}}function showHomeAssistantPopup(){showLoadingWindow("Loading Home Assistant data..."),window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.get_ha_data?window.pywebview.api.get_ha_data().then((e=>{removeLoadingWindow();let t=null,n=Boolean(e.ha_enabled);try{t=e.ha_data?JSON.parse(e.ha_data):null}catch(e){t=null}n&&t?showHomeAssistantManagePopup(t):showHomeAssistantSetupPopup(t)})).catch((e=>{removeLoadingWindow(),showToast({message:"Failed to load Home Assistant data",type:"error"})})):(removeLoadingWindow(),showToast({message:"Backend not available",type:"error"}))}function showHomeAssistantSetupPopup(e){showPopupBelowHeader({title:"Setup Home Assistant",contentHtml:`\n        <div style="text-align:left;padding:1rem;">\n            <div style="margin-bottom:1.5rem;">\n                <label for="haUrlInput" style="display:block;margin-bottom:0.5rem;color:var(--text-light);">Home Assistant Base URL</label>\n                <input type="text" id="haUrlInput" placeholder="http://192.168.1.2:8123" \n                       value="${e?escapeHtml(e.url||""):""}"\n                       style="width:100%;padding:0.7rem;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;margin-bottom:1rem;">\n                <div style="font-size:0.9rem;color:#888;margin-bottom:1rem;">\n                    Enter the full URL including protocol (http:// or https://). If you don't include the protocol, https:// will be automatically added.\n                </div>\n            </div>\n            <div style="margin-bottom:1.5rem;">\n                <label for="haTokenInput" style="display:block;margin-bottom:0.5rem;color:var(--text-light);">Long-lived Access Token</label>\n                <input type="password" id="haTokenInput" placeholder="Enter your Home Assistant token" \n                       value="${e?escapeHtml(e.token||""):""}"\n                       style="width:100%;padding:0.7rem;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;">\n                <div style="font-size:0.9rem;color:#888;margin-top:0.5rem;">\n                    You can create a long-lived access token in your Home Assistant profile settings.\n                </div>\n            </div>\n        </div>\n        <div style="display:flex;justify-content:space-between;margin-top:2rem;gap:1rem;">\n            <button id="haBackBtn" style="background:#444;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">Back</button>\n            <button id="haTestSetupBtn" style="background:#222;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">Test Connection</button>\n            <button id="haEnableBtn" style="background:#6366f1;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">Enable Home Assistant</button>\n        </div>\n    `,onClose:closePopupBelowHeader}),setTimeout((()=>{document.getElementById("haBackBtn").onclick=()=>closePopupBelowHeader(),document.getElementById("haTestSetupBtn").onclick=()=>testHomeAssistantSetupConnection(),document.getElementById("haEnableBtn").onclick=()=>enableHomeAssistant()}),100)}function showHomeAssistantManagePopup(e){showPopupBelowHeader({title:"Manage Home Assistant",contentHtml:`\n        <div style="text-align:left;padding:1rem;">\n            <div style="background:#222;color:#4ade80;padding:1rem;border-radius:8px;margin-bottom:1.5rem;">\n                <strong>âœ“ Home Assistant is currently enabled</strong><br>\n                URL: ${escapeHtml(e.url)}<br>\n                Token: ${escapeHtml(e.token.substring(0,10))}...\n            </div>\n        </div>\n        <div style="display:flex;justify-content:space-between;margin-top:2rem;gap:1rem;">\n            <button id="haBackBtn" style="background:#444;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">Back</button>\n            <button id="haTestManageBtn" style="background:#222;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">Test Connection</button>\n            <button id="haDisableBtn" style="background:#dc2626;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">Disable Home Assistant</button>\n        </div>\n    `,onClose:closePopupBelowHeader}),setTimeout((()=>{document.getElementById("haBackBtn").onclick=()=>closePopupBelowHeader(),document.getElementById("haTestManageBtn").onclick=()=>testHomeAssistantConnection(),document.getElementById("haDisableBtn").onclick=()=>showDisableHomeAssistantConfirmation()}),100)}async function enableHomeAssistant(){const e=document.getElementById("haUrlInput"),t=document.getElementById("haTokenInput");let n=e.value.trim();const o=t.value.trim();if(n&&o){n.startsWith("http://")||n.startsWith("https://")||(n="https://"+n),showLoadingWindow("Testing Home Assistant connection...");try{const e=await isHomeAssistantUp(n,o);removeLoadingWindow(),e?showHomeAssistantRestartConfirmation(n,o,!0):showToast({message:"Failed to connect to Home Assistant. Please check your URL and token.",type:"error"})}catch(e){removeLoadingWindow(),showToast({message:"Error testing connection: "+e.message,type:"error"})}}else showToast({message:"Please fill in both URL and token fields",type:"error"})}async function testHomeAssistantSetupConnection(){const e=document.getElementById("haUrlInput"),t=document.getElementById("haTokenInput");let n=e.value.trim();const o=t.value.trim();if(n&&o){n.startsWith("http://")||n.startsWith("https://")||(n="https://"+n),showLoadingWindow("Testing Home Assistant connection...");try{const e=await isHomeAssistantUp(n,o);removeLoadingWindow(),showToast(e?{message:"Connection successful! Your Home Assistant is accessible.",type:"success"}:{message:"Failed to connect to Home Assistant. Please check your URL and token.",type:"error"})}catch(e){removeLoadingWindow(),showToast({message:"Error testing connection: "+e.message,type:"error"})}}else showToast({message:"Please fill in both URL and token fields before testing",type:"error"})}async function testHomeAssistantConnection(){if(window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.get_ha_data)try{const e=await window.pywebview.api.get_ha_data();let t=null;try{t=e.ha_data?JSON.parse(e.ha_data):null}catch(e){t=null}if(!t||!t.url||!t.token)return void showToast({message:"No Home Assistant configuration found",type:"error"});let n=t.url.trim();const o=t.token.trim();n.startsWith("http://")||n.startsWith("https://")||(n="https://"+n),showLoadingWindow("Testing Home Assistant connection...");try{const e=await isHomeAssistantUp(n,o);removeLoadingWindow(),showToast(e?{message:"Connection successful!",type:"success"}:{message:"Failed to connect to Home Assistant. Please check your configuration.",type:"error"})}catch(e){removeLoadingWindow(),showToast({message:"Error testing connection: "+e.message,type:"error"})}}catch(e){showToast({message:"Error getting Home Assistant data: "+e.message,type:"error"})}else showToast({message:"Backend not available",type:"error"})}function showHomeAssistantRestartConfirmation(e,t,n){showPopupBelowHeader({title:"Home Assistant "+(n?"Enabled":"Disabled"),contentHtml:`\n        <div style="text-align:center;padding:2rem;">\n            <div style="color:#4ade80;font-size:2rem;margin-bottom:1rem;">âœ“</div>\n            <h3 style="margin-bottom:1rem;">Home Assistant ${n?"Enabled":"Disabled"}</h3>\n            <p style="margin-bottom:2rem;color:#888;">\n                ${n?"Your Home Assistant integration has been successfully configured and tested. The application will restart to apply the changes.":"Home Assistant integration will be disabled. The application will restart to apply the changes."}\n            </p>\n        </div>\n        <div style="display:flex;justify-content:center;gap:1rem;margin-top:2rem;">\n            <button id="haContinueBtn" style="background:#6366f1;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">Continue</button>\n            <button id="haCancelBtn" style="background:#444;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">Cancel</button>\n        </div>\n    `,onClose:closePopupBelowHeader}),setTimeout((()=>{document.getElementById("haContinueBtn").onclick=()=>{showLoadingWindow("Saving Home Assistant configuration...");const o=JSON.stringify({url:e,token:t});window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.save_ha_data?window.pywebview.api.save_ha_data(o,n).then((e=>{e.success?showToast({message:"Home Assistant configuration saved successfully",type:"success"}):(removeLoadingWindow(),showToast({message:"Failed to save configuration: "+e.message,type:"error"}))})).catch((e=>{removeLoadingWindow(),showToast({message:"Error saving configuration: "+e,type:"error"})})):(removeLoadingWindow(),showToast({message:"Backend not available",type:"error"}))},document.getElementById("haCancelBtn").onclick=()=>closePopupBelowHeader()}),100)}function showDisableHomeAssistantConfirmation(){showPopupBelowHeader({title:"Disable Home Assistant",contentHtml:'\n        <div style="text-align:center;padding:2rem;">\n            <div style="color:#fbbf24;font-size:2rem;margin-bottom:1rem;">âš </div>\n            <h3 style="margin-bottom:1rem;">Disable Home Assistant?</h3>\n            <p style="margin-bottom:2rem;color:#888;">\n                Are you sure you want to disable Home Assistant integration? This will remove the ability to control your smart home devices through Emily AI.\n            </p>\n        </div>\n        <div style="display:flex;justify-content:center;gap:1rem;margin-top:2rem;">\n            <button id="haDisableConfirmBtn" style="background:#dc2626;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">Disable</button>\n            <button id="haDisableCancelBtn" style="background:#444;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">Cancel</button>\n        </div>\n    ',onClose:closePopupBelowHeader}),setTimeout((()=>{document.getElementById("haDisableConfirmBtn").onclick=()=>{showLoadingWindow("Disabling Home Assistant..."),window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.save_ha_data?window.pywebview.api.save_ha_data("",!1).then((e=>{e.success?showToast({message:"Home Assistant disabled successfully",type:"success"}):(removeLoadingWindow(),showToast({message:"Failed to disable: "+e.message,type:"error"}))})).catch((e=>{removeLoadingWindow(),showToast({message:"Error disabling: "+e,type:"error"})})):(removeLoadingWindow(),showToast({message:"Backend not available",type:"error"}))},document.getElementById("haDisableCancelBtn").onclick=()=>closePopupBelowHeader()}),100)}function escapeHtml(e){return"string"!=typeof e?"":e.replace(/[&<>"']/g,(function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]}))}function closeSettingsWindow(){closePopupBelowHeader()}function saveSettings(){const e=document.getElementById("languageSelect").value,t="true"===document.getElementById("aiSpeechSelect").value;let n=!1;e!==userLang&&(n=!0),t!==isvoiseactive&&(n=!0),n?showSettingsChangeConfirmPopup(e,t):closeSettingsWindow()}function showSettingsChangeConfirmPopup(e,t){const n=document.createElement("div");n.id="settings-confirm-overlay",n.style.cssText="\n        position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index:2000;\n        background:rgba(0,0,0,0.55); backdrop-filter:blur(6px); align-items:center; justify-content:center;\n        display:flex;\n    ";const o=document.createElement("div");o.id="settings-confirm-popup",o.style.cssText="\n        background:rgba(20,16,40,0.98); border-radius:18px; padding:2rem 2.5rem; min-width:320px; max-width:90vw;\n        color:#fff; box-shadow:0 8px 32px rgba(0,0,0,0.25); display:flex; flex-direction:column; align-items:center;\n    ",o.innerHTML='\n        <div style="font-size:1.2rem;font-weight:600;margin-bottom:1.2rem;text-align:center;">Confirm Settings Change?</div>\n        <div id="lang-confirm-message" style="font-size:1.05rem;line-height:1.6;text-align:center;margin-bottom:2rem;">Are you sure you want to change the Settings? This will affect immediately.</div>\n        <div style="display:flex;gap:1.5rem;justify-content:center;">\n            <button id="settings-confirm-cancel" style="background:rgba(255,255,255,0.1);color:var(--text-light);border:1px solid rgba(255,255,255,0.2);padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">Cancel</button>\n            <button id="settings-confirm-continue" style="background:#6366f1;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">Continue</button>\n        </div>\n    ',n.appendChild(o),document.body.appendChild(n);const i=()=>{const e=document.getElementById("settings-confirm-overlay");e&&e.remove()};document.getElementById("settings-confirm-cancel").addEventListener("click",(function(){document.getElementById("languageSelect").value=userLang,document.getElementById("aiSpeechSelect").value=String(isvoiseactive),i()})),document.getElementById("settings-confirm-continue").addEventListener("click",(async function(){try{let n=!1;e!==userLang&&(updateVoiceLanguage(e),window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.add_record&&(await window.pywebview.api.add_record("userLang",e),showToast({message:"Voice recognition language updated successfully",type:"success",duration:3e3}),n=!0)),t!==isvoiseactive&&window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.add_record&&(await window.pywebview.api.add_record("isvoiseactive",String(t)),isvoiseactive=t,showToast({message:`AI Speech ${t?"enabled":"disabled"} successfully`,type:"success",duration:3e3}),n=!0),n&&showToast({message:"Settings updated successfully",type:"success",duration:3e3})}catch(e){showToast({message:"Error saving settings",type:"error",duration:4e3})}finally{i(),closeSettingsWindow()}}))}function updateAiSpeechSetting(e){isvoiseactive=e,window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.add_record&&window.pywebview.api.add_record("isvoiseactive",String(e)).then((t=>{t&&t.success?showToast({message:`AI Speech ${e?"enabled":"disabled"} successfully`,type:"success",duration:3e3}):showToast({message:`Failed to save AI Speech setting: ${t?.message||"Unknown error"}`,type:"error",duration:4e3})})).catch((e=>{showToast({message:"Error saving AI Speech setting.",type:"error",duration:4e3})}))}function handleRestoreDataClick(){showPopupBelowHeader({title:"Restore Data",contentHtml:'\n        <div style="display:flex;flex-direction:column;align-items:center;gap:1.5rem;min-width:340px;max-width:95vw;">\n            <i style="font-size:2.5rem;" class="fad fa-upload"></i>\n            <div style="font-size:1.3rem;font-weight:600;text-align:center;">Restore Chat History</div>\n            <div style="color:#a3a3a3;font-size:1.05rem;text-align:center;">\n                This will replace your current chat history with the backup data.<br>\n                <span style=\'color:#f59e42;font-size:1.05rem;\'>Current chat history will be lost.</span>\n            </div>\n            <div style="color:#a3a3a3;font-size:1.05rem;text-align:center;">\n                Only .emily_bp files created with your current account can be restored.\n            </div>\n            <div style="display:flex;gap:1.2rem;justify-content:center;margin-top:0.5rem;">\n                <button id="restore-confirm-btn" style="background:linear-gradient(90deg,#6366f1,#4f46e5);color:white;border:none;padding:0.7rem 1.5rem;border-radius:0.7rem;font-weight:500;cursor:pointer;transition:all 0.2s;box-shadow:0 2px 8px rgba(99,102,241,0.12);">Select Backup File</button>\n                <button id="restore-cancel-btn" style="background:rgba(255,255,255,0.1);color:var(--text-light);border:1px solid rgba(255,255,255,0.2);padding:0.7rem 1.5rem;border-radius:0.7rem;font-weight:500;cursor:pointer;transition:all 0.2s;">Cancel</button>\n            </div>\n        </div>\n    ',proGlow:!1}),setTimeout((()=>{const e=document.getElementById("restore-confirm-btn"),t=document.getElementById("restore-cancel-btn");e&&(e.onclick=function(){openRestoreFileDialog()}),t&&(t.onclick=function(){closePopupBelowHeader()})}),10)}function openRestoreFileDialog(){if(window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.open_restore_file_dialog)try{window.pywebview.api.open_restore_file_dialog()}catch(e){showToast({message:"Error opening file dialog: "+e.message,type:"error",duration:4e3})}else showToast({message:"Restore function not available.",type:"error",duration:4e3})}function handleRestoreFileSelect(e){if(closePopupBelowHeader(),!e)return;const t=document.createElement("div");t.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0,0,0,0.7);\n        backdrop-filter: blur(4px);\n        z-index: 2000;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n    ";const n=document.createElement("div");n.style.cssText="\n        background: rgba(20, 16, 40, 0.98);\n        border-radius: 14px;\n        padding: 2rem;\n        width: 95vw;\n        max-width: 420px;\n        color: white;\n        text-align: center;\n        box-shadow: 0 8px 32px rgba(0,0,0,0.25);\n    ",n.innerHTML='\n        <div style="margin-bottom: 1.5rem;">\n            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #6366f1; margin-bottom: 1rem;"></i>\n            <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">Restoring Data</h3>\n            <p style="color: var(--text-medium);">Please wait while we restore your backup...</p>\n        </div>\n    ',t.appendChild(n),document.body.appendChild(t),window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.restore_data?window.pywebview.api.restore_data(e).then((e=>{if(t.remove(),e&&e.success){const o=document.createElement("div");o.style.cssText=t.style.cssText;const i=document.createElement("div");i.style.cssText=n.style.cssText,i.innerHTML=`\n                    <div style="margin-bottom: 1.5rem;">\n                        <i class="fas fa-check-circle" style="font-size: 2rem; color: #10b981; margin-bottom: 1rem;"></i>\n                        <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">Restore Successful</h3>\n                        <p style="color: var(--text-medium);">${e.message}</p>\n                        <p style="color: #10b981; font-weight: 500;">${e.restored_count} chat interactions restored.</p>\n                        <p style="color: #f59e42; font-size: 0.95rem; margin-top: 1rem;">\n                            <i class="fas fa-info-circle"></i> The application will restart to apply the restored data.\n                        </p>\n                    </div>\n                    <div style="display: flex; justify-content: center;">\n                        <button id="restore-success-ok" style="background: #10b981; color: white; border: none; padding: 0.7rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer;">Continue</button>\n                    </div>\n                `,o.appendChild(i),document.body.appendChild(o),document.getElementById("restore-success-ok").onclick=function(){o.remove(),showLoadingWindow("Restarting application to apply restored data..."),window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.restart_application?window.pywebview.api.restart_application():setTimeout((()=>{location.reload()}),2e3)}}else showToast({message:e.message||"Failed to restore backup.",type:"error",duration:4e3})})).catch((e=>{t.remove(),showToast({message:"Failed to restore backup: "+(e.message||"Unknown error"),type:"error",duration:4e3})})):(t.remove(),showToast({message:"Restore function not available.",type:"error",duration:4e3}))}function handleSubscriptionClick(){const e=window.APP_CONFIG||APP_CONFIG||DEFAULT_CONFIG,t=(e["user-type"]||"free").toLowerCase(),n=e.user&&e.user.subscription?e.user.subscription:{},o=n.plan?n.plan.toUpperCase():"FREE",i=n.expires_at||"N/A",a=n.created_at||"N/A",r=e.max_message_length||500;let s="N/A";if(i&&"N/A"!==i){const e=new Date,t=new Date(i.replace(/-/g,"/"));if(!isNaN(t.getTime())){const n=t-e;s=n>0?Math.ceil(n/864e5):0}}showPopupBelowHeader({title:"Subscription Details",contentHtml:`\n        <div style="display:grid;grid-template-columns:1fr 1fr;gap:2rem 3rem;font-size:1.15rem;">\n            <div style="text-align:left;"><b>User Type:</b> <span style="color:#ffd700;">${t}</span></div>\n            <div style="text-align:left;"><b>Plan:</b> <span style="color:#ffd700;">${o}</span></div>\n            <div style="text-align:left;"><b>Start At:</b> <span style="color:#ffd700;">${a}</span></div>\n            <div style="text-align:left;"><b>Expires At:</b> <span style="color:#ffd700;">${i}</span></div>\n            <div style="text-align:left;"><b>Remaining Days:</b> <span style="color:#ffd700;">${s}</span></div>\n            <div style="text-align:left;"><b>Max Message Length:</b> <span style="color:#ffd700;">${r}</span></div>\n        </div>\n        <div style="margin-top:2rem;text-align:center;">\n            <button onclick="showRedeemPopup()" style="background:linear-gradient(to right,#6366f1,#4f46e5);color:white;border:none;padding:0.7rem 1.5rem;border-radius:0.7rem;font-weight:500;cursor:pointer;transition:all 0.2s;box-shadow:0 2px 8px rgba(99,102,241,0.12);">Redeem Subscription</button>\n        </div>\n    `,proGlow:"PRO"===t})}function showRedeemPopup(){closePopupBelowHeader();const e=document.createElement("div");e.id="redeem-overlay",e.style.cssText="\n        position: fixed;\n        top: 0; left: 0; right: 0; bottom: 0;\n        background: rgba(0,0,0,0.7);\n        backdrop-filter: blur(8px);\n        z-index: 5000;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        animation: fadeIn 0.3s;\n    ";const t=document.createElement("div");t.id="redeem-popup",t.style.cssText="\n        background: rgba(20, 16, 40, 0.98);\n        border-radius: 18px;\n        padding: 2rem 2.5rem;\n        width: 95vw;\n        max-width: 450px;\n        color: #fff;\n        box-shadow: 0 8px 32px rgba(0,0,0,0.25);\n    ",t.innerHTML='\n        <div id="redeem-step-1">\n            <h3 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; text-align: center;">Redeem Subscription</h3>\n            <p style="color: var(--text-medium); text-align: center; margin-bottom: 1.5rem;">If you have an already active subscription, the new subscription duration will be added to your current one.</p>\n            <input id="redeem-code-input" type="text" placeholder="Enter your redemption code" style="width:100%;padding:0.7rem 1rem;border-radius:8px;border:1px solid var(--border-light);background:rgba(255,255,255,0.08);color:#fff;font-size:1rem;margin-bottom:1.5rem;outline:none;" />\n            <div style="display:flex;gap:1rem;justify-content:center;">\n                <button id="redeem-cancel-btn" style="background:rgba(255,255,255,0.1);color:var(--text-light);border:1px solid rgba(255,255,255,0.2);padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">Cancel</button>\n                <button id="redeem-continue-btn" style="background:#6366f1;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">Continue</button>\n            </div>\n        </div>\n        <div id="redeem-step-2" style="display:none;">\n             <h3 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; text-align: center;">Confirm Subscription</h3>\n             <div id="redeem-details" style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: left;"></div>\n             <p style="color: #ffd700; text-align: center; margin-bottom: 1.5rem;">(Activating subscription will restart the application)</p>\n             <div style="display:flex;gap:1rem;justify-content:center;">\n                <button id="redeem-back-btn" style="background:rgba(255,255,255,0.1);color:var(--text-light);border:1px solid rgba(255,255,255,0.2);padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">Back</button>\n                <button id="redeem-confirm-btn" style="background:#10b981;color:white;border:none;padding:0.7rem 1.5rem;border-radius:8px;font-weight:500;cursor:pointer;">Redeem</button>\n            </div>\n        </div>\n    ',e.appendChild(t),document.body.appendChild(e),document.getElementById("redeem-cancel-btn").onclick=()=>e.remove(),document.getElementById("redeem-back-btn").onclick=()=>{document.getElementById("redeem-step-2").style.display="none",document.getElementById("redeem-step-1").style.display="block"},document.getElementById("redeem-continue-btn").onclick=checkRedeemCode,document.getElementById("redeem-confirm-btn").onclick=applyRedeemCode}function checkRedeemCode(){const e=document.getElementById("redeem-code-input").value.trim();if(e)if(window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.get_subcription){const t=document.getElementById("redeem-continue-btn");t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin"></i>',window.pywebview.api.get_subcription(e).then((n=>{if(t.disabled=!1,t.textContent="Continue",n&&n.success&&n.data){document.getElementById("redeem-popup").dataset.code=e;document.getElementById("redeem-details").innerHTML=`\n                        <p><strong>Plan:</strong> ${n.data.plan.toUpperCase()}</p>\n                        <p><strong>Duration:</strong> ${n.data.duration} days</p>\n                    `,document.getElementById("redeem-step-1").style.display="none",document.getElementById("redeem-step-2").style.display="block"}else showToast({message:n.message||"Invalid or expired redemption code.",type:"error"})})).catch((e=>{t.disabled=!1,t.textContent="Continue",showToast({message:"An error occurred while checking the code.",type:"error"})}))}else showToast({message:"Cannot verify code. API not available.",type:"error"});else showToast({message:"Please enter a redemption code.",type:"error"})}function applyRedeemCode(){const e=document.getElementById("redeem-popup").dataset.code;if(e)if(window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.apply_subcription){const t=document.getElementById("redeem-overlay");t&&t.remove(),showLoadingWindow("Activating subscription and restarting application..."),window.pywebview.api.apply_subcription(e).then((e=>{e&&!e.success&&(removeLoadingWindow(),showToast({message:e.message||"Failed to apply subscription.",type:"error"}))})).catch((e=>{removeLoadingWindow(),showToast({message:"An error occurred while applying the subscription.",type:"error"})}))}else showToast({message:"Cannot apply subscription. API not available.",type:"error"});else showToast({message:"Redemption code not found. Please go back and try again.",type:"error"})}function isValidHttpUrl(e){let t;try{t=new URL(e)}catch(e){return!1}return"http:"===t.protocol||"https:"===t.protocol}function showPopupBelowHeader({title:e,contentHtml:t,proGlow:n=!1,onClose:o=null}){closePopupBelowHeader();let i=document.getElementById("popup-title-section");i||(i=document.createElement("div"),i.id="popup-title-section",document.querySelector(".header").insertBefore(i,document.querySelector(".profile-section"))),i.style.display="flex",i.style.alignItems="center",i.innerHTML=`<span style="font-size:1.2rem;font-weight:600;">${e}</span>`;const a=document.getElementById("sidebar-toggle");if(a){window._originalSidebarToggleHTML||(window._originalSidebarToggleHTML=a.outerHTML),a.innerHTML='<i class="fad fa-times"></i>',a.onclick=()=>{closePopupBelowHeader(),o&&o()},a.replaceWith(a.cloneNode(!0));const e=document.getElementById("sidebar-toggle");e&&(e.innerHTML='<i class="fad fa-times"></i>',e.onclick=()=>{closePopupBelowHeader(),o&&o()},e.style.display="")}const r=document.createElement("div");r.className="popup-under-header"+(n?" pro-glow":""),r.id="popup-under-header",r.innerHTML=t,document.body.appendChild(r)}function closePopupBelowHeader(){const e=document.getElementById("popup-under-header");e&&e.remove();const t=document.getElementById("popup-title-section");t&&(t.style.display="none");const n=document.getElementById("sidebar-toggle");if(n&&window._originalSidebarToggleHTML){n.outerHTML=window._originalSidebarToggleHTML;const e=document.getElementById("sidebar-toggle");e&&e.addEventListener("click",(()=>{sidebar.classList.toggle("collapsed"),mainContent.classList.toggle("expanded")})),window._originalSidebarToggleHTML=null}}function updateUserTypeBox(){const e=document.getElementById("user-type-box");if(!e)return;const t=((window.APP_CONFIG||APP_CONFIG||DEFAULT_CONFIG)["user-type"]||"free").toLowerCase();let n=t.charAt(0).toUpperCase()+t.slice(1);e.innerHTML='<i class="fad fa-diamond" style="font-size: 1rem;"></i><span>'+n+"</span>","pro"===t?e.classList.add("pro-glow"):e.classList.remove("pro-glow")}function updateSubscriptionButton(){const e=document.getElementById("subscription-button");if(!e)return;const t=((window.APP_CONFIG||APP_CONFIG||DEFAULT_CONFIG)["user-type"]||"free").toLowerCase();"pro"===t?e.classList.add("pro-button"):e.classList.remove("pro-button");const n=document.getElementById("subscription-button"),o=document.getElementById("subscription-icon");n&&o&&("pro"===t?n.classList.add("pro-glow"):n.classList.remove("pro-glow"))}function showToast({message:e,type:t="info",duration:n=3e3}){const o=document.getElementById("toast-container");if(!o)return;const i=document.createElement("div");let a;switch(i.className=`toast ${t}`,t){case"success":a="fa-check-circle";break;case"error":a="fa-exclamation-circle";break;case"warning":a="fa-exclamation-triangle";break;default:a="fa-info-circle"}i.innerHTML=`\n        <i class="fas ${a} toast-icon"></i>\n        <div class="toast-message">${e}</div>\n        <button class="toast-close" onclick="this.parentElement.remove()">\n            <i class="fad fa-times"></i>\n        </button>\n    `,o.appendChild(i),requestAnimationFrame((()=>{i.classList.add("show")})),n>0&&setTimeout((()=>{i.classList.add("hide"),setTimeout((()=>{i.remove()}),300)}),n)}function openExternalLink(e){window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.open_url?window.pywebview.api.open_url(e).then((e=>{e.success?showToast({message:"Profile page opened in browser",type:"success",duration:3e3}):showToast({message:e.message||"Failed to open profile page",type:"error",duration:4e3})})).catch((e=>{showToast({message:"Failed to open profile page",type:"error",duration:4e3})})):showToast({message:"Unable to open external link",type:"error",duration:4e3})}function showClearHistoryConfirmation(){const e=document.createElement("div");e.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0, 0, 0, 0.7);\n        backdrop-filter: blur(4px);\n        z-index: 1000;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n    ";const t=document.createElement("div");t.style.cssText="\n        background: rgba(239, 68, 68, 0.1);\n        border: 1px solid rgba(239, 68, 68, 0.3);\n        border-radius: 12px;\n        padding: 1.5rem;\n        width: 90%;\n        max-width: 400px;\n        color: white;\n        text-align: center;\n    ",t.innerHTML='\n        <div style="margin-bottom: 1.5rem;">\n            <i class="fas fa-exclamation-triangle" style="\n                color: #ef4444;\n                font-size: 2rem;\n                margin-bottom: 1rem;\n            "></i>\n            <h3 style="\n                font-size: 1.2rem;\n                font-weight: 600;\n                margin-bottom: 0.5rem;\n                color: #ef4444;\n            ">Clear Chat History</h3>\n            <p style="\n                color: var(--text-medium);\n                line-height: 1.5;\n            ">Are you sure you want to clear AI\'s history? This action cannot be undone and will close the application.</p>\n        </div>\n        <div style="\n            display: flex;\n            gap: 1rem;\n            justify-content: center;\n        ">\n            <button onclick="closeClearHistoryConfirmation()" style="\n                background: rgba(255, 255, 255, 0.1);\n                color: var(--text-light);\n                border: 1px solid rgba(255, 255, 255, 0.2);\n                padding: 0.75rem 1.5rem;\n                border-radius: 8px;\n                font-weight: 500;\n                cursor: pointer;\n                transition: all 0.2s ease;\n            ">Cancel</button>\n            <button onclick="confirmClearHistory()" style="\n                background: #ef4444;\n                color: white;\n                border: none;\n                padding: 0.75rem 1.5rem;\n                border-radius: 8px;\n                font-weight: 500;\n                cursor: pointer;\n                transition: all 0.2s ease;\n            ">Continue</button>\n        </div>\n    ',e.appendChild(t),document.body.appendChild(e)}function closeClearHistoryConfirmation(){const e=document.querySelector('div[style*="backdrop-filter: blur(4px)"]');e&&e.remove()}function showLoadingWindow(e="Loading..."){removeLoadingWindow();const t=document.createElement("div");t.id="global-loading-window",t.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0, 0, 0, 0.8);\n        backdrop-filter: blur(4px);\n        z-index: 1001;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        flex-direction: column;\n        gap: 1rem;\n    ",t.innerHTML=`\n        <div class="thinking-animation">\n            <div class="thinking-dot"></div>\n            <div class="thinking-dot"></div>\n            <div class="thinking-dot"></div>\n        </div>\n        <div style="color: white; font-size: 1.1rem;">${e}</div>\n    `,document.body.appendChild(t)}function removeLoadingWindow(){const e=document.getElementById("global-loading-window");e&&e.remove()}function confirmClearHistory(){window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.clear_history_and_restart?(showLoadingWindow("Clearing history and closing application..."),window.pywebview.api.clear_history_and_restart().then((e=>{e.success||(showToast({message:e.message||"Failed to clear history",type:"error",duration:3e3}),removeLoadingWindow())})).catch((e=>{showToast({message:"Failed to clear history",type:"error",duration:3e3}),removeLoadingWindow()}))):showToast({message:"Unable to clear history",type:"error",duration:3e3})}attachmentButton.addEventListener("click",(e=>{e.stopPropagation(),isAttachmentDropdownOpen=!isAttachmentDropdownOpen,attachmentDropdown.classList.toggle("show",isAttachmentDropdownOpen)})),document.addEventListener("click",(()=>{isAttachmentDropdownOpen&&(isAttachmentDropdownOpen=!1,attachmentDropdown.classList.remove("show"))})),sidebarToggle.addEventListener("click",(()=>{sidebar.classList.toggle("collapsed"),mainContent.classList.toggle("expanded")})),document.addEventListener("keydown",(e=>{"\\"===e.key&&e.ctrlKey&&(sidebar.classList.toggle("collapsed"),mainContent.classList.toggle("expanded"))})),document.querySelectorAll(".attachment-option").forEach((e=>{e.addEventListener("click",(()=>{const t=e.dataset.type;if("video"===t)return void alert("Video uploads are currently disabled.");if(uploadConfig[t].currentCount>=uploadConfig[t].maxFiles)return void alert(`Maximum ${uploadConfig[t].maxFiles} ${t}(s) allowed`);const n=selectedFiles.length;if(n>=5)return void alert("Maximum 5 files allowed in total");const o=document.createElement("input");o.type="file",o.accept=getAcceptForType(t),o.multiple=!0,o.style.display="none",document.body.appendChild(o),o.onchange=e=>{if(e.target.files&&e.target.files.length>0){const o=Array.from(e.target.files);if(n+o.length>5)return void alert("Cannot add more files. Maximum 5 files allowed in total.");if(uploadConfig[t].currentCount+o.length>uploadConfig[t].maxFiles)return void alert(`Cannot add more ${t} files. Maximum ${uploadConfig[t].maxFiles} allowed.`);o.forEach((e=>{const n="."+e.name.split(".").pop().toLowerCase(),o=APP_CONFIG.allowed_extensions[t]||[];if(!o.includes(n))return void alert(`Invalid file type for ${e.name}. Allowed extensions for ${t}: ${o.join(", ")}`);if(e.size>20971520)return void alert(`File ${e.name} exceeds 20MB limit. Please choose a smaller file.`);const i=new FileReader;i.onload=n=>{selectedFiles.push({name:e.name,type:t,data:n.target.result,size:e.size,mimeType:e.type}),addFilePreview(e.name,t),uploadConfig[t].currentCount++},i.readAsDataURL(e)}))}document.body.removeChild(o)},o.click()}))})),document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("chat-area");e.querySelectorAll("pre").forEach(wrapCodeBlockInMessage);new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.length&&e.addedNodes.forEach((e=>{1===e.nodeType&&("PRE"===e.tagName?wrapCodeBlockInMessage(e):e.querySelectorAll("pre").forEach(wrapCodeBlockInMessage))}))}))})).observe(e,{childList:!0,subtree:!0})})),messageInput.addEventListener("input",autoResizeTextarea),messageInput.addEventListener("keypress",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),sendMessage())})),sendButton.addEventListener("click",sendMessage),window.addEventListener("load",(()=>{updateUserProfile(USER_INFO),setTimeout((()=>{loadUserInfo()}),500),emptyChatPlaceholder&&(emptyChatPlaceholder.style.display="none",addMessageToChat({sender:"- Emily AI",text:"**Hello! I'm Emily AI. How can I help you today?**",isUser:!1})),autoResizeTextarea(),messageInput.focus(),window.APP_CONFIG?initializeApp(window.APP_CONFIG):isPywebviewReady()?initializeWithBackend():waitForPywebview((()=>{initializeWithBackend(),loadUserInfo()})),setTimeout((()=>{if(window.pywebview&&window.pywebview.api){const e=findApiFunction("echo");e&&e("Hello from JavaScript").then((e=>{})).catch((e=>{}))}}),1e3),setTimeout((()=>{updateUserTypeBox()}),1e3),setTimeout((()=>{updateSubscriptionButton()}),1e3),cleanupPendingAttachments()}));let voiceRecognition=null,isVoiceMode=!1,isListening=!1,finalTranscript="",isProcessingResponse=!1,userLang="en-US",isRecognitionActive=!1,isvoiseactive=!1;async function checkMicrophoneAvailability(){try{return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach((e=>e.stop())),!0}catch(e){return!1}}function updateVoiceLanguage(e){userLang=e,voiceRecognition&&(voiceRecognition.lang=userLang)}function safelyStopListening(){if(isRecognitionActive){try{voiceRecognition.stop()}catch(e){}isRecognitionActive=!1,isListening=!1}}function safelyStartListening(){if(audioPlaybackInProgress)return!1;if(!isVoiceMode)return!1;if(isRecognitionActive)return!0;try{return setTimeout((()=>{if(isVoiceMode&&!isRecognitionActive&&!audioPlaybackInProgress)try{isRecognitionActive=!0,voiceRecognition.start()}catch(e){isRecognitionActive=!1,"InvalidStateError"===e.name&&e.message.includes("already started")||setTimeout((()=>safelyStartListening()),500)}}),300),!0}catch(e){return isRecognitionActive=!1,!1}}function startListening(){safelyStartListening()}function stopListening(){safelyStopListening()}function initVoiceChat(){const e=document.getElementById("voice-button"),t=document.getElementById("send-button"),n=document.getElementById("message-input");if(!("webkitSpeechRecognition"in window)&&!("SpeechRecognition"in window))return void(e.style.display="none");const o=window.SpeechRecognition||window.webkitSpeechRecognition;voiceRecognition=new o,voiceRecognition.lang=userLang,voiceRecognition.continuous=!1,voiceRecognition.maxAlternatives=1,voiceRecognition.interimResults=!0,voiceRecognition.filterProfanities=!1,e.addEventListener("click",(async()=>{if(isVoiceMode){if(isVoiceMode=!1,isRecognitionActive)try{voiceRecognition.stop()}catch(e){}isListening=!1,isRecognitionActive=!1,finalTranscript="",n.value="",e.innerHTML='<i class="fas fa-microphone"></i>',n.placeholder="Type your message...",n.readOnly=!1,n.style.cursor="text",n.style.opacity="1",t.style.display="flex",updateVoiceUI()}else{if(!await checkMicrophoneAvailability())return void showToast({message:"Microphone access denied. Please allow microphone access to use voice input.",type:"error",duration:5e3});isVoiceMode=!0,e.innerHTML='<i class="fas fa-comments"></i>',n.placeholder="Listening...",n.readOnly=!0,n.style.cursor="not-allowed",n.style.opacity="0.7",t.style.display="none",startListening()}})),voiceRecognition.onstart=()=>{isVoiceMode?(isListening=!0,updateVoiceUI(),finalTranscript="",n.value=""):voiceRecognition.stop()},voiceRecognition.onend=()=>{isListening=!1,isRecognitionActive=!1,isVoiceMode&&setTimeout((()=>{isVoiceMode&&!isRecognitionActive&&startListening()}),100),updateVoiceUI()},voiceRecognition.onerror=e=>{isRecognitionActive=!1,isListening=!1,isVoiceMode&&("audio-capture"===e.error?(showToast({message:"No microphone detected. Please check your microphone connection.",type:"error",duration:5e3}),isVoiceMode=!1):"not-allowed"===e.error?(showToast({message:"Microphone access denied. Please allow microphone access to use voice input.",type:"error",duration:5e3}),isVoiceMode=!1):"aborted"!==e.error&&"network"!==e.error||isVoiceMode&&setTimeout((()=>{isVoiceMode&&!isRecognitionActive&&startListening()}),1e3),updateVoiceUI())},voiceRecognition.onresult=e=>{let t="";for(let o=e.resultIndex;o<e.results.length;o++){const i=e.results[o][0].transcript;e.results[o].isFinal?(finalTranscript=i,n.value=finalTranscript,finalTranscript.trim().length>0&&handleVoiceMessage(finalTranscript)):t+=i}t&&(n.value=t)},n.addEventListener("keydown",(e=>{isVoiceMode&&e.preventDefault()}))}function handleVoiceMessage(e){isProcessingResponse=!0,stopListening(),finalTranscript="",messageInput.value="",messageInput.value=e,"function"==typeof sendMessage&&sendMessage()}function updateVoiceUI(){const e=document.getElementById("voice-button"),t=document.getElementById("send-button"),n=document.getElementById("message-input");isVoiceMode?isListening?(e.innerHTML='<i class="fas fa-comments"></i>',e.className="w-12 h-12 flex items-center justify-center rounded-full bg-gradient-to-r from-blue-600 to-blue-500 text-white shadow-lg hover:from-blue-500 hover:to-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all transform hover:scale-105 active:scale-95",n.placeholder="Listening...",n.readOnly=!0,n.style.cursor="not-allowed",n.style.opacity="0.7",t.style.display="none"):(e.innerHTML='<i class="fas fa-comments"></i>',e.className="w-12 h-12 flex items-center justify-center rounded-full bg-gradient-to-r from-gray-600 to-gray-500 text-white shadow-lg hover:from-gray-500 hover:to-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-all transform hover:scale-105 active:scale-95",n.placeholder=isProcessingResponse?"Processing response...":"Voice mode active - Click to switch to text",n.readOnly=!0,n.style.cursor="not-allowed",n.style.opacity="0.7",t.style.display="none"):(e.innerHTML='<i class="fas fa-microphone"></i>',e.className="w-12 h-12 flex items-center justify-center rounded-full bg-gradient-to-r from-indigo-600 to-purple-500 text-white shadow-lg hover:from-indigo-500 hover:to-purple-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all transform hover:scale-105 active:scale-95",n.placeholder="Type your message...",n.readOnly=!1,n.style.cursor="text",n.style.opacity="1",t.style.display="flex")}document.addEventListener("DOMContentLoaded",(()=>{initVoiceChat()}));let currentAudio=null,audioContext=null,analyser=null,visualizerCanvas=null,visualizerContext=null,animationFrame=null,audioCache={},gainNode=null,audioPlaybackCompleteCallback=null,audioPlaybackInProgress=!1;function initAudioVisualizer(){audioContext||(audioContext=new(window.AudioContext||window.webkitAudioContext),"suspended"===audioContext.state&&audioContext.resume().then((()=>{})).catch((e=>{})),analyser=audioContext.createAnalyser(),analyser.fftSize=256,gainNode=audioContext.createGain(),gainNode.gain.value=1.5),visualizerCanvas||(visualizerCanvas=document.getElementById("audio-visualizer-canvas"),visualizerContext=visualizerCanvas.getContext("2d"),visualizerCanvas.width=200,visualizerCanvas.height=40)}function drawVisualizer(){if(!analyser||!visualizerContext)return;const e=analyser.frequencyBinCount,t=new Uint8Array(e);analyser.getByteFrequencyData(t),visualizerContext.clearRect(0,0,visualizerCanvas.width,visualizerCanvas.height),visualizerContext.fillStyle="rgba(99, 102, 241, 0.2)";const n=visualizerCanvas.width/e*2.5;let o=0;for(let i=0;i<e;i++){const e=t[i]/255*visualizerCanvas.height;visualizerContext.fillRect(o,visualizerCanvas.height-e,n,e),o+=n+1}animationFrame=requestAnimationFrame(drawVisualizer)}function stopAudioPlayback(){currentAudio&&(currentAudio.pause(),currentAudio=null),animationFrame&&(cancelAnimationFrame(animationFrame),animationFrame=null);const e=document.getElementById("audio-player-popup");if(e&&(e.style.display="none"),audioPlaybackInProgress=!1,"function"==typeof audioPlaybackCompleteCallback){const e=audioPlaybackCompleteCallback;audioPlaybackCompleteCallback=null,setTimeout(e,500)}}function playAudio(e,t){stopAudioPlayback(),audioPlaybackInProgress=!0,audioPlaybackCompleteCallback="function"==typeof t?t:null;const n=document.getElementById("audio-player-popup");if(!n)return showToast({message:"Audio player not available.",type:"error",duration:3e3}),audioPlaybackInProgress=!1,void("function"==typeof audioPlaybackCompleteCallback&&setTimeout(audioPlaybackCompleteCallback,500));const o=e=>{if(audioContext&&"suspended"===audioContext.state)audioContext.resume().then((()=>{initAudioVisualizer();audioContext.createMediaElementSource(e).connect(analyser),analyser.connect(gainNode),gainNode.connect(audioContext.destination),e.play().catch((e=>{stopAudioPlayback()})),n.style.display="block",drawVisualizer()})).catch((e=>{stopAudioPlayback()}));else{initAudioVisualizer();audioContext.createMediaElementSource(e).connect(analyser),analyser.connect(gainNode),gainNode.connect(audioContext.destination),e.play().catch((e=>{stopAudioPlayback()})),n.style.display="block",drawVisualizer()}};if(audioCache[e]){const t=new Audio(audioCache[e]);return currentAudio=t,t.onended=()=>{stopAudioPlayback()},t.onerror=e=>{showToast({message:"Error playing cached audio.",type:"error",duration:3e3}),stopAudioPlayback()},void o(t)}const i=new Audio(e);currentAudio=i,i.onended=()=>{stopAudioPlayback()},i.onerror=e=>{showToast({message:"Error playing audio.",type:"error",duration:3e3}),stopAudioPlayback()},o(i)}function playAudioResponse(e){safelyStopListening(),stopAudioPlayback(),playAudio(e,(()=>{isVoiceMode&&safelyStartListening()}))}function finishSetup(){document.getElementById("loadingScreen").classList.add("active");const e={voiceLanguage:document.getElementById("languageSelectsetup").value,aiSpeechEnabled:aiSpeechEnabled};setTimeout((()=>{document.getElementById("setupOverlay").classList.remove("active"),window.pywebview&&window.pywebview.api&&"function"==typeof window.pywebview.api.finishsetup?window.pywebview.api.finishsetup(e).then((()=>{})).catch((e=>{alert("Setup completed, but failed to notify backend.")})):"function"==typeof window.finishSetup?window.finishSetup(e):alert("Error, please restart.")}),3e3)}window.playAudioResponse=playAudioResponse,document.getElementById("audio-stop-btn").addEventListener("click",stopAudioPlayback),document.addEventListener("keydown",(function(e){"F11"===e.key&&(e.preventDefault(),window.pywebview&&window.pywebview.api&&window.pywebview.api.toggle_fullscreen())}));
